<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Receiver - HLS con CAF v3 + Shaka</title>

  <!-- Cargar el SDK de receiver; omitir protocolo para compatibilidad HTTP/HTTPS -->
  <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <!-- (Opcional) Logger de debug para desarrollo -->
  <script src="//www.gstatic.com/cast/sdk/libs/devtools/debug_layer/caf_receiver_logger.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width:100%; height:100%; background: #000; color: #fff; }
    cast-media-player { width:100%; height:100%; }
  </style>
</head>
<body>
  <!-- Elemento de player predeterminado de CAF -->
  <cast-media-player></cast-media-player>

  <script>
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();
    const castDebugLogger = cast.debug.CastDebugLogger.getInstance();

    // Habilitar overlay de debug (solo durante desarrollo)
    context.addEventListener(cast.framework.system.EventType.READY, () => {
      if (!castDebugLogger.debugOverlayElement_) {
        castDebugLogger.setEnabled(true);
        castDebugLogger.loggerLevelByEvents = {
          'cast.framework.events.category.CORE': cast.framework.LoggerLevel.INFO,
          'cast.framework.events.EventType.MEDIA_STATUS': cast.framework.LoggerLevel.DEBUG
        };
      }
    });

    // Interceptor de LOAD — útil si querés modificar contentId, contentUrl, metadata, etc.
    playerManager.setMessageInterceptor(
      cast.framework.messages.MessageType.LOAD,
      (loadRequestData) => {
        const media = loadRequestData.media;
        if (!media) {
          return loadRequestData;  // dejar pasar
        }

        // Si la request usa contentId y querés convertirlo a contentUrl:
        if (media.contentId && !media.contentUrl) {
          media.contentUrl = media.contentId;
        }

        // Asumir stream HLS
        media.contentType = 'application/x-mpegurl';
        // Si los segmentos HLS están en CMAF / fMP4:
        media.hlsSegmentFormat = cast.framework.messages.HlsSegmentFormat.FMP4;
        media.hlsVideoSegmentFormat = cast.framework.messages.HlsVideoSegmentFormat.FMP4;

        loadRequestData.media = media;
        return loadRequestData;
      }
    );

    // Opciones de receiver: usar Shaka Player para HLS (por defecto en CAF v3 desde Nov 2025)
    const options = new cast.framework.CastReceiverOptions();
    options.useShakaForHls = true;
    // (Opcional) fijar versión de Shaka — no es necesario salvo que tengas un requisito específico
    // options.shakaVersion = '4.15.12';

    context.start(options);
  </script>
</body>
</html>
