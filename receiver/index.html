<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Receiver Shaka + ClearKey</title>

  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.15.12/dist/shaka-player.compiled.js"></script>

  <style>
    body { margin:0; background:black; display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; color:white; }
    video { width:100%; max-width:1280px; height:auto; background:black; }
    #status { margin-top:10px; font-size:16px; color:#aaa; }
  </style>
</head>
<body>
  <video id="video" autoplay controls></video>
  <div id="status">Esperando media...</div>

  <script>
    const video = document.getElementById('video');
    const player = new shaka.Player(video);

    // ConfiguraciÃ³n ClearKey
    player.configure({
      drm: {
        clearKeys: {
          '0123456789abcdef0123456789abcdef': '0123456789abcdef0123456789abcdef'
        }
      }
    });

    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    // Interceptar LOAD
    playerManager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, (loadRequestData) => {
      const media = loadRequestData.media;
      if(media && media.contentId){
        player.load(media.contentId).then(() => {
          document.getElementById('status').textContent = 'Reproduciendo: ' + media.contentId;
        }).catch(e => {
          console.error('Error Shaka:', e);
          document.getElementById('status').textContent = 'Error cargando media';
        });
      }
      return loadRequestData;
    });

    context.start();

    context.addEventListener(cast.framework.CastReceiverEventType.CAST_CHANNEL_CONNECTED, () => {
      document.getElementById('status').textContent = 'Sender conectado';
    });

    context.addEventListener(cast.framework.CastReceiverEventType.CAST_CHANNEL_DISCONNECTED, () => {
      document.getElementById('status').textContent = 'Esperando media...';
    });
  </script>
</body>
</html>
