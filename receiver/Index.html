<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPTV+ — Custom Receiver</title>
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.15.12/shaka-player.compiled.js"></script>
  <style>
    body{font-family:system-ui;margin:12px}
    #log{white-space:pre-wrap;background:#111;color:#eee;padding:12px;border-radius:6px;height:160px;overflow:auto}
  </style>
</head>
<body>
  <h3>IPTV+ — Receiver</h3>
  <div id="status">Inicializando…</div>
  <div id="log"></div>

  <script>
    const logEl=document.getElementById('log');
    const statusEl=document.getElementById('status');
    const log=(...a)=>{const t=new Date().toISOString()+' | '+a.join(' ')+'\n';logEl.textContent=t+logEl.textContent;console.log(...a);} 
    const setStatus=s=>statusEl.textContent=s;

    const ctx=cast.framework.CastReceiverContext.getInstance();
    const pm=ctx.getPlayerManager();

    let player=null,video=null;
    function ensureShaka(){
      if(player) return player;
      video=document.createElement('video');
      video.setAttribute('playsinline','');
      video.style.width='100%';
      document.body.appendChild(video);
      player=new shaka.Player(video);
      return player;
    }

    function base64ToHex(b){ try{const r=atob(b);let h='';for(let i=0;i<r.length;i++)h+=r.charCodeAt(i).toString(16).padStart(2,'0');return h;}catch(e){return null;} }

    pm.setMessageInterceptor(cast.framework.messages.MessageType.LOAD,async req=>{
      try{
        log('LOAD',JSON.stringify(req));
        const media=req.media;
        if(!media||!media.contentId) return req;

        const src=media.contentId;
        const custom=media.customData||{};

        const p=ensureShaka();

        // ---- CLEARKEY AUTOMÁTICO PARA EL MPD QUE ME PASASTE ----
        // keyId : key  (ya en HEX)
        const clearkey_kid="cc8c82ac2ec7e9799527c29db7354e81";
        const clearkey_key="cc4aae173dd2ef17ae26be3f7ae87662";

        const drmCfg={
          clearKeys:{ [clearkey_kid]: clearkey_key }
        };

        p.configure({ drm: drmCfg });
        log('DRM ClearKey aplicado',JSON.stringify(drmCfg));

        const loadPromise=p.load(src);
        const timeout=15000;
        await Promise.race([
          loadPromise,
          new Promise((_,rej)=>setTimeout(()=>rej('timeout loading mpd'),timeout))
        ]);

        log('MPD OK',src);
        setStatus('Reproduciendo: '+src);
        pm.broadcastStatus(true);
        return req;

      }catch(e){ log('ERROR LOAD',e); return null; }
    });

    pm.addEventListener(cast.framework.events.EventType.PLAY,()=>pm.broadcastStatus(true));
    pm.addEventListener(cast.framework.events.EventType.PAUSE,()=>pm.broadcastStatus(true));
    pm.addEventListener(cast.framework.events.EventType.SEEK,()=>pm.broadcastStatus(true));
    pm.addEventListener(cast.framework.events.EventType.STOP,()=>pm.broadcastStatus(false));

    ctx.start();
    setStatus('Receiver listo');
    log('Receiver iniciado');
</body>
</html>
