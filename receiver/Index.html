<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Custom Receiver ‚Äî Shaka ClearKey</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.15.12/shaka-player.compiled.js"></script>
<script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000}
  video{width:100%;height:100%;background:#000}
</style>
</head>
<body>

<video id="video" autoplay></video>

<script>
(async () => {

  //---------------------------------------------------------------------------
  // üîê CLEARKEYS PRIVADAS ‚Äî SOLO EN EL RECEIVER
  //---------------------------------------------------------------------------

  const CLEARKEYS = {
    "https://cdn.cvattv.com.ar/live/c6eds/Canal7/SA_Live_dash_enc/Canal7.mpd": {
      "cc8c82ac2ec7e9799527c29db7354e81": "cc4aae173dd2ef17ae26be3f7ae87662"
    },

    // EJEMPLO para agregar m√°s canales:
    // "https://otro.mpd": {
    //   "KEYID": "KEY"
    // }
  };

  //---------------------------------------------------------------------------
  // CAST + SHAKA SETUP
  //---------------------------------------------------------------------------

  const video = document.getElementById('video');
  const player = new shaka.Player(video);

  const context = cast.framework.CastReceiverContext.getInstance();
  const manager = context.getPlayerManager();

  // Errores de Shaka
  player.addEventListener('error', e => console.error('Shaka error:', e.detail));

  // Cuando el sender env√≠a un LOAD
  manager.setMessageInterceptor(
    cast.framework.messages.MessageType.LOAD,
    async request => {

      const url = request.media.contentId;

      console.log("Cargando media:", url);

      // Buscar claves del canal solicitado
      const keys = CLEARKEYS[url];

      if (keys) {
        console.log("Clave encontrada para", url);

        player.configure({
          drm: {
            clearKeys: keys
          }
        });
      } else {
        console.warn("No hay claves para:", url);
      }

      // Reemplaza el sistema de carga interno del CAF por Shaka
      try {
        await player.load(url);
        console.log("Reproducci√≥n iniciada");
      } catch(err) {
        console.error("Error cargando MPD:", err);
      }

      // Cancelar que CAF intente manejar la carga tradicional
      return null;
    }
  );

  context.start();

})();
</script>

</body>
</html>
  // Handler para LOAD (intercepta la carga desde el sender)
  manager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, async (loadRequestData) => {
    try{
      const media = loadRequestData.media;
      if(!media){ console.warn('LOAD sin media'); return loadRequestData; }

      const src = media.contentId;
      const customData = media.customData || {};
      // Shaka espera clearKeys en hex
      const drmConfig = (customData.shaka && customData.shaka.drm) || {};

      // configurar Shaka
      player.configure({ drm: drmConfig });

      // Cuidado: las llamadas await dentro del interceptor pueden bloquear la respuesta si fallan.
      await player.load(src);

      // Despu√©s de cargar, actualizamos la metadata del manager
      // (broadcastStatus actualiza puntos como duration/position)
      manager.broadcastStatus(true);
      console.log('LOAD OK ->', src);
      return loadRequestData;
    }catch(err){
      console.error('Error en LOAD interceptor:', err);
      // retornar null evita que el SDK procese el LOAD por defecto
      return null;
    }
  });

  // Control play/pause/seek/stop: mapear comandos al video/shaka
  const toPlayPause = ({shouldPlay}) => {
    try{
      if(shouldPlay) video.play();
      else video.pause();
    }catch(e){ console.warn('play/pause error', e); }
    manager.broadcastStatus(true);
  };

  // El SDK ofrece interceptors para controles si los necesit√°s (ejemplo conceptual):
  manager.setMessageInterceptor(cast.framework.messages.MessageType.PAUSE, request => {
    video.pause();
    manager.broadcastStatus(true);
    return request;
  });
  manager.setMessageInterceptor(cast.framework.messages.MessageType.PLAY, request => {
    video.play();
    manager.broadcastStatus(true);
    return request;
  });
  manager.setMessageInterceptor(cast.framework.messages.MessageType.SEEK, request => {
    try{
      const seekTime = request.currentTime || request.seekTime || (request && request.seek && request.seek.currentTime);
      if(typeof seekTime === 'number' && !isNaN(seekTime)) video.currentTime = seekTime;
      manager.broadcastStatus(true);
    }catch(e){ console.warn('seek error', e); }
    return request;
  });

  // Empezar receiver
  context.start();

  // Debug: reportar estado de Shaka -> manager peri√≥dicamente (opcional)
  setInterval(()=>{
    // sincronizar posici√≥n y estado con el sender
    manager.broadcastStatus(true);
  }, 1000);

})();
</script>
</body>
</html>
