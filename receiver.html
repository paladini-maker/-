<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Shaka Cast Receiver Minimal - FIXED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.7/shaka-player.compiled.js"></script>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <style>
        * { margin: 0; padding: 0; }
        body { 
            overflow: hidden; 
            background: #000; 
            font-family: Arial, sans-serif;
        }
        video { 
            width: 100%; 
            height: 100%;
            background: #000;
        }
        #debugOverlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-size: 12px;
            font-family: monospace;
            padding: 10px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border: 1px solid #0f0;
            display: none;
        }
    </style>
</head>
<body>

    <video id="video" class="castMediaElement"></video>
    <div id="debugOverlay"></div>

    <script>
        // ✅ NEW: Debug logging helper
        const debugLogs = [];
        const MAX_DEBUG_LOGS = 10;

        function debugLog(message, level = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const log = `[${timestamp}] ${level}: ${message}`;
            debugLogs.push(log);
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            
            console.log(log);
            updateDebugOverlay();
        }

        function updateDebugOverlay() {
            const overlay = document.getElementById('debugOverlay');
            overlay.innerHTML = debugLogs.map(log => log + '<br>').join('');
        }

        // ✅ NEW: Toggle debug overlay with 'D' key
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'd') {
                const overlay = document.getElementById('debugOverlay');
                overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
            }
        });

        async function init() {
            try {
                debugLog('Iniciando receptor...');

                // Get Cast instances
                const context = cast.framework.CastReceiverContext.getInstance();
                const playerManager = context.getPlayerManager();
                const video = document.getElementById('video');

                if (!context || !playerManager || !video) {
                    throw new Error('No se pudo obtener instancias de Cast Framework');
                }

                debugLog('Instancias de Cast Framework obtenidas');

                // ✅ NEW: Configure Shaka Player with error handling
                let shakaPlayer;
                try {
                    // Check if Shaka is available
                    if (!window.shaka) {
                        throw new Error('Shaka Player no cargado');
                    }

                    shakaPlayer = new shaka.Player(video);
                    debugLog('Shaka Player instanciado');

                    // ✅ NEW: Configure Shaka with better settings
                    shakaPlayer.configure({
                        streaming: {
                            bufferingGoal: 10,
                            rebufferingGoal: 2,
                            bufferBehind: 30,
                            jumpLargeGaps: false,
                            alwaysStreamText: false
                        },
                        manifest: {
                            dash: {
                                clockSyncUri: ''
                            }
                        },
                        abr: {
                            defaultBandwidthEstimate: 2500000, // 2.5 Mbps
                            switchInterval: 8,
                            bandwidthDowngradeTarget: 0.75
                        }
                    });

                    debugLog('Shaka Player configurado');

                    // ✅ NEW: Add error listeners to Shaka
                    shakaPlayer.addEventListener('error', (event) => {
                        const error = event.detail;
                        debugLog(`Shaka Error: ${error.category} - ${error.code}: ${error.message}`, 'ERROR');
                        console.error('Shaka Player Error:', error);
                    });

                    shakaPlayer.addEventListener('adaptation', (event) => {
                        debugLog(`Adaptación: ${event.detail.type}`, 'ADAPT');
                    });

                } catch (shakaErr) {
                    debugLog(`Error de Shaka: ${shakaErr.message}`, 'ERROR');
                    throw shakaErr;
                }

                // ✅ NEW: Create CastReceiver with proper error handling
                try {
                    const castReceiver = new shaka.cast.CastReceiver(context, playerManager, shakaPlayer);
                    debugLog('CastReceiver inicializado');
                } catch (castErr) {
                    debugLog(`Error de CastReceiver: ${castErr.message}`, 'ERROR');
                    throw castErr;
                }

                // ✅ NEW: Custom event listeners for Cast Context
                context.addEventListener(
                    cast.framework.CastContextEventType.BEFORE_MEDIA_LOAD,
                    (event) => {
                        debugLog(`Media cargándose: ${event.data.media.contentId}`, 'LOAD');
                    }
                );

                context.addEventListener(
                    cast.framework.CastContextEventType.MEDIA_STATUS_UPDATED,
                    (event) => {
                        if (event.data) {
                            const status = event.data.status[0];
                            if (status) {
                                debugLog(
                                    `Estado: ${status.playerState} (${(status.currentTime || 0).toFixed(0)}s)`,
                                    'STATUS'
                                );
                            }
                        }
                    }
                );

                // ✅ NEW: Configure Cast Receiver options
                const castReceiverOptions = new cast.framework.CastReceiverOptions();
                castReceiverOptions.maxInactivityTimeout = 3600; // 1 hour
                castReceiverOptions.useShakaForHls = true; // Use Shaka for HLS streams
                castReceiverOptions.playbackConfig = new cast.framework.PlaybackConfig();
                castReceiverOptions.playbackConfig.autoResumeTimeout = 5;
                castReceiverOptions.playbackConfig.audioLanguage = 'en';

                // ✅ NEW: Start receiver with error handling
                context.start(castReceiverOptions).then(
                    () => {
                        debugLog('Receptor iniciado y esperando conexiones', 'SUCCESS');
                    },
                    (err) => {
                        debugLog(`Error al iniciar receptor: ${err}`, 'ERROR');
                        console.error('Error starting receiver:', err);
                    }
                ).catch((err) => {
                    debugLog(`Promise rejected en start(): ${err.message}`, 'ERROR');
                    console.error('Unexpected error:', err);
                });

            } catch (err) {
                debugLog(`Error fatal de inicialización: ${err.message}`, 'FATAL');
                console.error('Fatal initialization error:', err);
            }
        }

        // ✅ NEW: Call init when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // ✅ NEW: Graceful error handling for unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            debugLog(`Rechazo no manejado: ${event.reason}`, 'ERROR');
            console.error('Unhandled Promise Rejection:', event.reason);
        });

        // ✅ NEW: Log all console errors
        const originalError = console.error;
        console.error = function(...args) {
            debugLog(`Console Error: ${args.join(' ')}`, 'ERROR');
            originalError.apply(console, args);
        };
    </script>
</body>
</html>