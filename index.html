<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Web Sender para Google Cast</title>
    
    <script src="https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }
        #controls {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: inline-block;
            background-color: #fff;
        }
        /* Estilo para el botón de Cast por defecto (gestionado por el SDK) */
        google-cast-button {
            --google-cast-button-color: #4285F4;
            --google-cast-button-width: 32px;
            --google-cast-button-height: 32px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Web Sender: Envío de Video de Muestra</h1>

    <google-cast-button></google-cast-button>

    <div id="controls">
        <button id="castButton" disabled>
            Cargar y Reproducir Video (Big Buck Bunny)
        </button>
        <p>Haga clic en el botón de Cast (arriba) y luego en el botón de Cargar.</p>
    </div>

    <script>
        // ID de la aplicación de Receptor de Medios Predeterminada (Default Media Receiver).
        // Si tienes una aplicación de receptor personalizada, debes usar su ID aquí.
        const APPLICATION_ID = 'CC1AD845'; 
        
        // URL y metadatos del contenido multimedia de muestra
        const MEDIA_URL = 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
        const MEDIA_TITLE = 'Big Buck Bunny (Muestra)';
        const MEDIA_SUBTITLE = 'Video de prueba para Cast';
        
        let castContext;
        
        /**
         * 3. Callback obligatorio para inicializar el SDK
         * Se ejecuta automáticamente cuando el script del SDK termina de cargarse.
         */
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            } else {
                console.error('La API de Google Cast no está disponible.');
            }
        };

        /**
         * Inicializa el contexto de Cast y configura las opciones.
         */
        function initializeCastApi() {
            // Configuración de las opciones de Cast
            const castOptions = new cast.framework.CastOptions();
            castOptions.receiverApplicationId = APPLICATION_ID;
            
            // Inicializar el contexto de Cast
            castContext = cast.framework.CastContext.getInstance();
            castContext.setOptions(castOptions);

            // Agregar listener para cambios de estado de sesión. 
            // Esto permite saber cuándo el usuario se conecta a un dispositivo.
            castContext.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                onSessionStateChange
            );
            
            // Habilitar el botón de carga de medio
            document.getElementById('castButton').disabled = false;
            document.getElementById('castButton').onclick = requestSessionAndLoadMedia;

            console.log('Contexto de Cast inicializado. Aplicación ID:', APPLICATION_ID);
        }

        /**
         * Maneja los cambios de estado de la sesión.
         */
        function onSessionStateChange(event) {
            const session = castContext.getCurrentSession();
            console.log('Estado de la sesión:', event.sessionState);

            if (event.sessionState === cast.framework.SessionState.SESSION_STARTED) {
                console.log('Sesión iniciada con éxito. Listo para cargar medio.');
            }
        }

        /**
         * Solicita una sesión de Cast o carga el medio si ya hay una sesión.
         */
        function requestSessionAndLoadMedia() {
            const session = castContext.getCurrentSession();
            
            if (session && session.isConnected()) {
                // Si ya hay una sesión conectada, cargamos el medio directamente.
                loadMedia(session);
            } else {
                // Solicitamos una sesión, lo que activará el diálogo de Cast.
                castContext.requestSession().then(function() {
                    // Si la sesión se inicia, el medio se cargará a través de onSessionStateChange
                    // o podemos llamarlo aquí si requestSession fue exitoso.
                    loadMedia(castContext.getCurrentSession());
                }, function(error) {
                    console.error('Error al solicitar la sesión:', error);
                    alert('Error al intentar conectar: ' + error.code);
                });
            }
        }

        /**
         * Crea la solicitud de carga y la envía a la sesión de Cast activa.
         */
        function loadMedia(session) {
            if (!session) {
                console.error("Error: No hay una sesión de Cast activa.");
                return;
            }

            console.log('Creando solicitud de carga de medio...');
            
            // 4. Crear MediaInfo con la URL y tipo de contenido
            const mediaInfo = new chrome.cast.media.MediaInfo(MEDIA_URL, 'video/mp4');
            
            // 5. Crear Metadatos
            const mediaMetadata = new chrome.cast.media.MediaMetadata(chrome.cast.media.MetadataType.MOVIE);
            mediaMetadata.title = MEDIA_TITLE;
            mediaMetadata.subtitle = MEDIA_SUBTITLE;
            mediaInfo.metadata = mediaMetadata;

            // 6. Crear la solicitud de carga final
            const loadRequest = new chrome.cast.media.LoadRequest(mediaInfo);

            // 7. Enviar la solicitud a la sesión de Cast activa
            session.loadMedia(loadRequest).then(
                function() { 
                    console.log('Medio cargado y reproduciéndose exitosamente.');
                }, 
                function(errorCode) { 
                    console.error('Error al cargar el medio:', errorCode); 
                }
            );
        }
    </script>
</body>
</html>
