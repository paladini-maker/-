<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>IPTV Shaka Player</title>

  <!-- UI Shaka -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.4.1/controls.min.css">

  <!-- Chromecast Sender -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <!-- Shaka Player -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.4.1/shaka-player.compiled.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.4.1/shaka-player.ui.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: auto 1fr;
      gap: 5px;
      height: 100%;
    }

    #canales {
      overflow-y: auto;
      padding: 10px;
      background: #202020;
    }

    #player-container {
      grid-column: 2;
      grid-row: 1 / span 2;
      position: relative;
      background: black;
    }

    #video-container {
      width: 100%;
      height: 100%;
    }

    #consolePanel {
      height: 150px;
      background: black;
      overflow-y: auto;
      font-size: 12px;
      padding: 10px;
      border-top: 1px solid #444;
      white-space: pre-wrap;
    }

    .canal {
      padding: 6px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .canal:hover {
      background: #333;
    }

    .canal img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
  </style>
</head>
<body>

<div id="layout">

  <!-- Sidebar con grilla -->
  <div id="canales">
    <h3>Canales</h3>
    <div id="listaCanales"></div>
  </div>

  <!-- Reproductor -->
  <div id="player-container">
    <div id="video-container" data-shaka-player-container>
      <div data-shaka-player-ui></div>
      <video id="video" autoplay controls></video>
    </div>
  </div>

</div>

<!-- Consola visible -->
<div id="consolePanel"></div>

<script>
// ---------------------------
// Consola visible
// ---------------------------
const logPanel = document.getElementById('consolePanel');

function log(msg) {
  logPanel.textContent += msg + "\n";
  logPanel.scrollTop = logPanel.scrollHeight;
}

// Captura errores globales
window.onerror = (msg, src, line) => {
  log(`JS ERROR: ${msg} (${src}:${line})`);
};

// Captura console.error
const origError = console.error;
console.error = (...args) => {
  origError(...args);
  log("Console error: " + args.join(" "));
};

// ---------------------------
// Inicializar Shaka + UI + Cast
// ---------------------------
document.addEventListener("shaka-ui-loaded", () => {
  const video = document.getElementById('video');
  const container = document.getElementById('video-container');

  const ui = new shaka.ui.Overlay(shaka.Player, container, video);
  const controls = ui.getControls();
  const player = controls.getPlayer();

  ui.configure({
    controlPanelElements: [
      'play_pause',
      'time_and_duration',
      'cast',
      'mute',
      'volume',
      'fullscreen'
    ]
  });

  log("Shaka UI cargada correctamente.");

  // Manejo de errores del reproductor
  player.addEventListener('error', e => {
    log("Shaka ERROR: " + JSON.stringify(e.detail));
  });

  window.player = player; // debug
});

// ---------------------------
// Leer el M3U del repo
// ---------------------------
async function cargarM3U() {
  try {
    const res = await fetch("lista.m3u");
    const txt = await res.text();

    log("M3U cargado.");
    procesarM3U(txt);

  } catch (e) {
    log("ERROR cargando M3U: " + e);
  }
}

function procesarM3U(txt) {
  const lines = txt.split("\n").map(l => l.trim());
  const canales = [];
  let actual = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (line.startsWith("#EXTINF")) {
      const logo = line.match(/tvg-logo="([^"]*)"/)?.[1] || "";
      const name = line.split(",").pop().trim();
      actual = { name, logo };
    }

    else if (line.includes("license_key=")) {
      if (!actual) continue;

      const raw = line.split("license_key=")[1];
      const [kid, key] = raw.split(":");

      actual.kid = kid.trim();
      actual.key = key.trim();
    }

    else if (line.startsWith("http")) {
      if (!actual) continue;
      actual.url = line.trim();
      canales.push(actual);
      actual = null;
    }
  }

  mostrarCanales(canales);
}

function mostrarCanales(canales) {
  const lista = document.getElementById('listaCanales');
  lista.innerHTML = "";

  canales.forEach((c, i) => {
    const div = document.createElement("div");
    div.className = "canal";
    div.innerHTML = `
      <img src="${c.logo || ""}">
      <span>${c.name}</span>
    `;
    div.onclick = () => reproducir(c);
    lista.appendChild(div);
  });
}

// ---------------------------
// Reproducir canal
// ---------------------------
async function reproducir(c) {
  log("Reproduciendo: " + c.name);

  try {
    window.player.configure({
      drm: {
        clearKeys: {
          [c.kid]: c.key
        }
      }
    });

    await window.player.load(c.url);
    log("Canal cargado OK.");

  } catch (e) {
    console.error(e);
    log("ERROR al cargar canal: " + e);
  }
}

cargarM3U();
</script>
</body>
</html>
