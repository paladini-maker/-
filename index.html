<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Sender — Shaka + ClearKey + Cast</title>

<!-- Shaka Player UI -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.12/shaka-player.ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.12/controls.min.css"/>

<!-- Google Cast Sender -->
<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

<style>
  body { background:#111; color:#fff; font-family: Arial; margin:0; padding:20px; }
  #video { width:100%; max-width:900px; margin:auto; }
</style>
</head>

<body>
<h2>Shaka Player + ClearKey + Chromecast</h2>

<div id="video-container" data-shaka-player-container>
  <video id="video" data-shaka-player autoplay controls></video>
</div>

<script>
const APP_ID = "86E6AFAF";  // Tu custom receiver

const mpdUrl = "https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd";

const clearkeys = {
  "1ae8ccd0e6d74a618c5b2dd9e75a01a5": "3ae8ccd0e6d74a618c5b2dd9e75a01a5"
};

async function initShaka() {
  shaka.polyfill.installAll();
  if (!shaka.Player.isBrowserSupported()) {
    console.error("Navegador no soportado");
    return;
  }

  const video = document.getElementById("video");
  const player = new shaka.Player(video);

  player.configure({
    drm: {
      clearKeys: clearkeys
    }
  });

  try {
    await player.load(mpdUrl);
    console.log("Cargado en local");
  } catch (e) {
    console.error("Error loading MPD:", e);
  }
}

// ---- CAST SENDER SETUP ----
window.castFramework = window.castFramework || {};
let castContext;

window.onload = () => {
  initShaka();

  castContext = cast.framework.CastContext.getInstance();
  castContext.setOptions({
    receiverApplicationId: APP_ID,
    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
  });

  cast.framework.CastContext.getInstance().addEventListener(
    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
    (e) => console.log("Cast:", e.castState)
  );
};

// ---- BOTÓN CAST NATIVO DE SHAKA ----
document.addEventListener("shaka-ui-loaded", () => {
  const video = document.getElementById("video");
  const ui = video["ui"];
  const controls = ui.getControls();

  controls.getPlayer().configure({ drm: { clearKeys: clearkeys } });

  const castButton = controls.getControlsContainer().querySelector(".shaka-cast-button");
  console.log("Cast Button:", castButton);
});
</script>
</body>
</html>
