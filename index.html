<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaka Player + Google Cast</title>
    
    <!-- Estilos de Shaka Player -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/controls.min.css">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .video-container {
            width: 100%;
            margin: 0 auto 30px;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .status-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .status-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #fdbb2d;
            display: flex;
            align-items: center;
        }
        
        .status-title i {
            margin-right: 10px;
        }
        
        .status-content {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-height: 60px;
            display: flex;
            align-items: center;
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid #ff6b6b;
        }
        
        .info-box {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .info-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4dabf7;
        }
        
        .info-content {
            line-height: 1.6;
        }
        
        .cast-info {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .cast-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        .success {
            color: #51cf66;
        }
        
        .warning {
            color: #ffd43b;
        }
        
        .error-text {
            color: #ff6b6b;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 0 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Shaka Player + Google Cast</h1>
            <p class="subtitle">Reproducci贸n de video con capacidad de transmisi贸n a dispositivos Chromecast</p>
        </header>
        
        <div class="video-container" data-shaka-player-container>
            <video data-shaka-player id="video" 
                   poster="//shaka-player-demo.appspot.com/assets/poster.jpg"
                   playsinline></video>
        </div>
        
        <div class="status-panel">
            <div class="status-title">
                <i></i> Estado del reproductor
            </div>
            <div class="status-content" id="status">
                Inicializando Shaka Player y Google Cast...
            </div>
            <div class="cast-info" id="cast-info">
                <span class="cast-icon"></span>
                <span id="cast-status">Buscando dispositivos Chromecast...</span>
            </div>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="info-box">
            <div class="info-title">
                <i>癸</i> Informaci贸n
            </div>
            <div class="info-content">
                <p>Este reproductor utiliza Shaka Player para reproducir contenido en formato DASH y se integra con Google Cast para permitir la transmisi贸n a dispositivos Chromecast.</p>
                <p>Para usar la funci贸n Cast, aseg煤rate de tener un dispositivo Chromecast en la misma red y haz clic en el bot贸n de transmisi贸n en los controles del reproductor.</p>
            </div>
        </div>
    </div>

    <!-- Cargar Cast Framework primero -->
    <script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    
    <!-- Luego Shaka Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.ui.min.js"></script>

    <script>
        const manifestUri = 'https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd';
        // Usamos la aplicaci贸n de demostraci贸n p煤blica de Google
        const CAST_APP_ID = 'CC1AD845';

        // Estado global
        let castContext = null;
        let ui = null;
        let player = null;

        // Callback para cuando Cast Framework est谩 disponible
        window['__onGCastApiAvailable'] = function(isAvailable) {
            const statusElement = document.getElementById('status');
            const castStatusElement = document.getElementById('cast-status');
            
            if (isAvailable) {
                statusElement.textContent = 'Google Cast SDK disponible. Inicializando...';
                castStatusElement.textContent = 'Google Cast disponible. Buscando dispositivos...';
                castStatusElement.className = 'success';
                console.log('Google Cast SDK cargado y disponible.');
                
                try {
                    // Inicializar Cast Context
                    castContext = cast.framework.CastContext.getInstance();
                    castContext.setOptions({
                        receiverApplicationId: CAST_APP_ID,
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                    });
                    
                    // Esperar a que el DOM est茅 listo
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initPlayer);
                    } else {
                        initPlayer();
                    }
                } catch (error) {
                    console.error('Error inicializando Cast:', error);
                    statusElement.textContent = 'Error inicializando Google Cast. Usando modo local.';
                    castStatusElement.textContent = 'Error inicializando Google Cast.';
                    castStatusElement.className = 'error-text';
                    initPlayerWithoutCast();
                }
            } else {
                statusElement.textContent = 'Cast SDK no disponible. Usando modo local.';
                castStatusElement.textContent = 'Google Cast no disponible en este navegador.';
                castStatusElement.className = 'warning';
                console.warn("Cast SDK no est谩 disponible en este entorno.");
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initPlayerWithoutCast);
                } else {
                    initPlayerWithoutCast();
                }
            }
        };

        async function initPlayer() {
            try {
                const video = document.getElementById('video');
                const videoContainer = document.querySelector('.video-container');
                const statusElement = document.getElementById('status');
                const castStatusElement = document.getElementById('cast-status');
                
                // Inicializar Shaka Player
                const shakaPlayer = new shaka.Player(video);
                
                // Configurar Shaka Player
                shakaPlayer.configure({
                    drm: {
                        clearKeys: {}
                    }
                });

                // Inicializar UI
                ui = new shaka.ui.Overlay(shakaPlayer, videoContainer, video);
                player = shakaPlayer;

                // Configurar controles UI
                const config = {
                    cast: {
                        receiverApplicationId: CAST_APP_ID
                    },
                    controlPanelElements: [
                        'play_pause',
                        'mute',
                        'volume',
                        'time_and_duration',
                        'spacer',
                        'cast',
                        'fullscreen',
                        'overflow_menu'
                    ],
                    overflowMenuButtons: [
                        'quality',
                        'language',
                        'playback_rate',
                        'picture_in_picture'
                    ]
                };

                ui.configure(config);

                // Event listeners
                player.addEventListener('error', onErrorEvent);
                player.addEventListener('loading', () => {
                    statusElement.textContent = 'Cargando contenido...';
                });
                
                player.addEventListener('loaded', () => {
                    statusElement.textContent = 'Contenido cargado. Listo para reproducir.';
                });

                // Cast event listeners
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    onSessionStateChanged
                );

                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    onCastStateChanged
                );

                // Cargar el contenido
                await player.load(manifestUri);
                statusElement.textContent = 'Reproducci贸n local lista. Cast disponible.';
                
            } catch (error) {
                onError(error);
            }
        }

        function initPlayerWithoutCast() {
            const video = document.getElementById('video');
            const videoContainer = document.querySelector('.video-container');
            const statusElement = document.getElementById('status');
            
            const shakaPlayer = new shaka.Player(video);
            ui = new shaka.ui.Overlay(shakaPlayer, videoContainer, video);
            player = shakaPlayer;

            // Configuraci贸n sin Cast
            ui.configure({
                controlPanelElements: [
                    'play_pause',
                    'mute',
                    'volume',
                    'time_and_duration',
                    'spacer',
                    'fullscreen',
                    'overflow_menu'
                ]
            });

            player.addEventListener('error', onErrorEvent);
            
            player.load(manifestUri)
                .then(() => {
                    statusElement.textContent = 'Reproducci贸n local activa (Cast no disponible)';
                })
                .catch(onError);
        }

        function onSessionStateChanged(event) {
            const statusElement = document.getElementById('status');
            const castStatusElement = document.getElementById('cast-status');
            
            switch (event.sessionState) {
                case cast.framework.SessionState.SESSION_STARTED:
                    statusElement.textContent = 'Sesi贸n Cast iniciada - Transmitiendo a dispositivo Chromecast';
                    castStatusElement.textContent = 'Conectado y transmitiendo a Chromecast';
                    castStatusElement.className = 'success';
                    break;
                case cast.framework.SessionState.SESSION_RESUMED:
                    statusElement.textContent = 'Sesi贸n Cast reanudada';
                    castStatusElement.textContent = 'Sesi贸n Cast reanudada';
                    castStatusElement.className = 'success';
                    break;
                case cast.framework.SessionState.SESSION_ENDED:
                    statusElement.textContent = 'Sesi贸n Cast finalizada. Volviendo a reproducci贸n local.';
                    castStatusElement.textContent = 'No conectado a Chromecast';
                    castStatusElement.className = '';
                    break;
            }
        }

        function onCastStateChanged(event) {
            const castStatusElement = document.getElementById('cast-status');
            
            switch (event.castState) {
                case cast.framework.CastState.NO_DEVICES_AVAILABLE:
                    castStatusElement.textContent = 'No hay dispositivos Chromecast disponibles';
                    castStatusElement.className = 'warning';
                    break;
                case cast.framework.CastState.NOT_CONNECTED:
                    castStatusElement.textContent = 'No conectado a Chromecast';
                    castStatusElement.className = '';
                    break;
                case cast.framework.CastState.CONNECTING:
                    castStatusElement.textContent = 'Conectando a Chromecast...';
                    castStatusElement.className = '';
                    break;
                case cast.framework.CastState.CONNECTED:
                    castStatusElement.textContent = 'Conectado a Chromecast';
                    castStatusElement.className = 'success';
                    break;
            }
        }

        function onErrorEvent(event) {
            onError(event.detail);
        }

        function onError(error) {
            console.error('Error:', error);
            const errorElement = document.getElementById('error');
            errorElement.textContent = `Error: ${error.code} - ${error.message || 'Error desconocido'}`;
            errorElement.style.display = 'block';
            
            // Actualizar estado
            const statusElement = document.getElementById('status');
            statusElement.textContent = 'Error al cargar el contenido';
        }

        // Cleanup al cerrar la p谩gina
        window.addEventListener('beforeunload', () => {
            if (player) {
                player.destroy();
            }
            if (ui) {
                ui.destroy();
            }
        });

    </script>
</body>
    </html>
