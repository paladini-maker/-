<!DOCTYPE html>
<html>
<head>
    <title>Shaka Player con Cast Integration (Final)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/controls.min.css">
    
    <style>
        body { 
            background-color: #222; 
            color: white; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0;
            padding-top: 50px;
        }
        
        .video-container {
            width: 640px;
            max-width: 100%; /* Asegura ajuste m贸vil */
            margin: 0 auto;
        }
        
        video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <h1>Shaka Player + Google Cast</h1>

    <div class="video-container" data-shaka-player-container>
        <video data-shaka-player id="video" poster="//shaka-player-demo.appspot.com/assets/poster.jpg"></video>
    </div>

    <script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.ui.min.js"></script>

    <script>
        const manifestUri = 'https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd';
        const CAST_APP_ID = '86E6AFAF'; 

        // ---  CORRECCIN ARQUITECTNICA CLAVE: Inicializaci贸n de Cast ---
        // Esto garantiza que el objeto 'cast' exista antes de que Shaka intente configurarlo.
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                console.log('Google Cast SDK cargado y disponible.');
                // Solo iniciamos Shaka una vez que el DOM est茅 listo Y Cast est茅 disponible.
                document.addEventListener('DOMContentLoaded', init); 
            } else {
                console.error("Cast SDK no est谩 disponible en este entorno.");
                document.addEventListener('DOMContentLoaded', initWithoutCast); // Opci贸n de fallback
            }
        };


        async function init() {
            const video = document.getElementById('video');
            const videoContainer = document.querySelector('.video-container');
            
            // Inicializar UI y Player
            const ui = new shaka.ui.Overlay(new shaka.Player(video), videoContainer, video);
            const controls = ui.getControls();
            const player = controls.getPlayer();

            // 1. Configuraci贸n de Cast y Visibilidad del Bot贸n
            ui.configure({
                cast: {
                    receiverApplicationId: CAST_APP_ID,
                    androidReceiverCompatible: false
                },
                // Forzamos la visibilidad del bot贸n 'cast' en la barra principal (no en el men煤 oculto)
                controlPanelElements: [
                    'play_pause',
                    'time_and_duration',
                    'spacer',
                    'mute',
                    'volume',
                    'cast', 
                    'overflow_menu' 
                ],
                overflowMenuButtons: ['quality', 'language', 'playback_rate', 'picture_in_picture']
            });

            // Listeners
            player.addEventListener('error', onErrorEvent);
            controls.addEventListener('caststatuschanged', onCastStatusChanged);

            try {
                await player.load(manifestUri);
                console.log('Shaka Player inicializado. Esperando comandos de Cast...');
            } catch (e) {
                onError(e);
            }
        }
        
        // Funci贸n de fallback si Cast no est谩 disponible (ej. si usas Firefox o Safari)
        function initWithoutCast() {
            const video = document.getElementById('video');
            const videoContainer = document.querySelector('.video-container');
            const ui = new shaka.ui.Overlay(new shaka.Player(video), videoContainer, video);
            // El resto de la l贸gica de Shaka...
            ui.configure({ /* sin la configuraci贸n 'cast' */ });
            console.log('Shaka inicializado sin soporte de Cast.');
            // Aqu铆 puedes cargar el video sin el bot贸n de Cast.
            ui.getControls().getPlayer().load(manifestUri);
        }

        function onCastStatusChanged(e) {
            const newStatus = e['newStatus'];
            if (newStatus) {
                console.log("隆Conectado a Chromecast! Reproducci贸n delegada.");
            } else {
                console.log("Desconectado de Chromecast. Reproducci贸n local reanudada.");
            }
        }

        function onErrorEvent(event) {
            onError(event.detail);
        }

        function onError(error) {
            console.error('Shaka Error:', error.code, error);
        }

    </script>
</body>
</html>
