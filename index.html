<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPTV+ — Web Sender (Cast)</title>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px}
    input{width:70%;padding:8px;margin-right:8px}
    button{padding:8px 12px}
    #status{display:inline-block;margin-left:12px}
  </style>
</head>
<body>
  <h2>IPTV+ — Sender</h2>
  <p>Pegá aquí la URL del MPD:</p>
  <input id="mpd" placeholder="https://.../manifest.mpd" />
  <button id="btn" disabled>Conectar / Enviar</button>
  <span id="status">Cargando SDK...</span>

  <script>
    const APP_ID = 'AAA48312';
    const btn = document.getElementById('btn');
    const urlInput = document.getElementById('mpd');
    const statusEl = document.getElementById('status');

    function status(t,c='black'){ statusEl.textContent=t; statusEl.style.color=c; }

    function ensureCastReady(ms=5000){
      return new Promise(r=>{
        if(window.cast&&window.cast.framework) return r(true);
        window.__onGCastApiAvailable = ok=>r(!!ok);
        setTimeout(()=>r(!!(window.cast&&window.cast.framework)),ms);
      });
    }

    async function init(){
      if(!await ensureCastReady()) return status('Cast SDK no disponible','crimson');
      const ctx = cast.framework.CastContext.getInstance();
      ctx.setOptions({ receiverApplicationId:APP_ID, autoJoinPolicy:chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED });
      ctx.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED,e=>{
        if(e.sessionState===cast.framework.SessionState.SESSION_STARTED) status('Conectado','green');
        if(e.sessionState===cast.framework.SessionState.SESSION_ENDED) status('Sesión terminada','gray');
      });
      btn.disabled=false;
      btn.onclick=()=>send(ctx);
      status('Listo','green');
    }

    async function send(ctx){
      const mpd=urlInput.value.trim();
      if(!mpd) return status('Pegá un MPD válido','crimson');
      let s=ctx.getCurrentSession();
      if(!s){ try{s=await ctx.requestSession();}catch(e){return status('No se pudo abrir sesión','crimson');} }
      const info=new chrome.cast.media.MediaInfo(mpd,'application/dash+xml');
      info.metadata=new chrome.cast.media.GenericMediaMetadata();
      info.metadata.title='IPTV+ – Live';
      info.customData={ app:'iptv-plus', sentAt:Date.now() };
      const req=new chrome.cast.media.LoadRequest(info);
      req.autoplay=true;
      try{ await s.loadMedia(req); status('En reproducción','green'); }
      catch(e){ status('Error al cargar media','crimson'); }
    }

    init();
  </script>
</body>
</html>
