<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shaka + Cast (ClearKey) - Corregido</title>

  <!-- Shaka UI -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.3/controls.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.3/shaka-player.ui.min.js"></script>

  <!-- Google Cast Sender (framework) -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <style>
    body { background:#000; color:#fff; font-family: sans-serif; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; }
    h3 { margin: 0 0 16px 0; }
    .cast-wrapper { width:100%; max-width:800px; display:flex; justify-content:flex-end; margin-bottom:8px; }
    #video-container { width:100%; max-width:800px; }
    video { width:100%; height:auto; background:#111; }
    google-cast-launcher { width:44px; height:44px; cursor:pointer; --connected-color:#4285f4; --disconnected-color:#fff; }
    .warning { color: #ffcc00; font-size:0.9rem; margin-top:8px; }
  </style>
</head>
<body>
  <h3>Shaka + Cast (ClearKey) — Test</h3>

  <div class="cast-wrapper">
    <!-- Botón externo. Se "upgradea" cuando carga el SDK de Cast -->
    <google-cast-launcher id="cast-btn" title="Cast"></google-cast-launcher>
  </div>

  <div id="video-container">
    <!-- El overlay de Shaka se engancha a este contenedor -->
    <video id="video" poster="//shaka-player-demo.appspot.com/assets/poster.jpg" playsinline controls></video>
  </div>

  <div id="info" class="warning" aria-live="polite"></div>

<script>
  // --- CONFIG ---
  const MANIFEST_URI = "https://cdn.cvattv.com.ar/live/c6eds/Canal7/SA_Live_dash_enc/Canal7.mpd";
  const RECEIVER_APP_ID = "07AEE832"; // Reemplaza si tenés App ID propio (registra dominios en la consola Cast)
  const DRM_CLEARKEY = {
    drm: {
      clearKeys: {
        "cc8c82ac2ec7e9799527c29db7354e81": "cc4aae173dd2ef17ae26be3f7ae87662"
      }
    }
  };

  // --- HELPERS ---
  const infoEl = document.getElementById('info');
  function info(msg) { console.log(msg); infoEl.textContent = msg; }

  // Detectar entorno que probablemente no soporte Cast (WebView típico)
  const ua = navigator.userAgent || '';
  const isProbablyWebView = /\bwv\b|Android.*WebView|Version\/\d+\.\d+\s+Chrome\/\d+/i.test(ua) && !/Chrome\/\d+/i.test(ua);
  if (isProbablyWebView) {
    info('Atención: este WebView probablemente no ofrezca la API de Cast. Proba en Chrome para Android.');
  }
  if (location.protocol !== 'https:' && !location.hostname.match(/localhost|127\.0\.0\.1/)) {
    console.warn('Debes servir la página por HTTPS para que Cast funcione correctamente.');
  }

  // --- Inicialización: esperar la API de Cast, pero tener fallback ---
  let initCalled = false;
  // Este callback lo invoca el script de cast_sender.js cuando carga
  window['__onGCastApiAvailable'] = function(isAvailable) {
    if (isAvailable) {
      try {
        // Inicializar CastContext lo antes posible
        const ctx = cast.framework.CastContext.getInstance();
        ctx.setOptions({
          receiverApplicationId: RECEIVER_APP_ID,
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
        console.log('Cast API disponible y CastContext inicializado');
        info('Cast API disponible');
      } catch (err) {
        console.warn('Error al inicializar CastContext:', err);
        info('Cast API cargada, pero falló inicialización. Revisa App ID y consola.');
      }
    } else {
      console.warn('Cast API no disponible (isAvailable=false)');
      info('Cast API no disponible en este entorno.');
    }

    // Llamar initPlayer (solo una vez)
    if (!initCalled) { initCalled = true; initPlayer(); }
  };

  // Fallback: si la API nunca llamó al callback (por ejemplo carga lenta o bloqueo),
  // iniciamos el player local después de 1.5s para que no quede vacío.
  setTimeout(() => {
    if (!initCalled) {
      console.warn('Timeout esperando Cast API. Iniciando player local como fallback.');
      info('No llegó señal de Cast API — iniciando player local.');
      initCalled = true;
      initPlayer();
    }
  }, 1500);

  // --- Init Shaka Player ---
  async function initPlayer() {
    shaka.polyfill.installAll();

    const video = document.getElementById('video');
    const container = document.getElementById('video-container');

    const player = new shaka.Player(video);

    // Aplicar ClearKey (o servidor) antes de cargar
    player.configure(DRM_CLEARKEY);

    // Si la API de Cast está presente, creamos CastProxy.
    let castProxy = null;
    if (window.cast && cast.framework) {
      try {
        // androidReceiverCompatible true si el receptor es compatible con Android TV
        castProxy = new shaka.cast.CastProxy(video, player, RECEIVER_APP_ID, /*androidReceiverCompatible=*/ true);
        console.log('CastProxy creado');
      } catch (err) {
        console.warn('No se pudo crear CastProxy:', err);
      }
    } else {
      console.log('Cast framework no disponible: no se crea CastProxy.');
    }

    // Interfaz UI de Shaka. Incluye el control 'cast' — solo se mostrará si hay CastProxy.
    const ui = new shaka.ui.Overlay(player, container, video);
    ui.configure({
      controlPanelElements: ['play_pause', 'time_and_duration', 'spacer', 'mute', 'volume', 'cast', 'fullscreen'],
      overflowMenuButtons: ['quality', 'language']
    });

    // Manejo de errores del player
    player.addEventListener('error', (evt) => {
      console.error('Shaka error', evt.detail);
      info('Error Shaka: ' + (evt.detail && evt.detail.message ? evt.detail.message : 'revisar consola'));
    });

    // Intentamos cargar el manifiesto
    try {
      await player.load(MANIFEST_URI);
      console.log('Manifiesto cargado correctamente');
      info('Reproduciendo (local). Si Cast está disponible, usa el botón para transmitir.');
    } catch (e) {
      console.error('Error cargando contenido:', e);
      info('Error cargando contenido. Revisa CORS, servidor y claves ClearKey.');
    }

    // Opcional: escuchar cambios de estado del contexto Cast
    if (window.cast && cast.framework) {
      const ctx = cast.framework.CastContext.getInstance();
      ctx.addEventListener(cast.framework.CastContextEventType.CAST_STATE_CHANGED, (e) => {
        console.log('Cast state:', ctx.getCastState());
      });
    }
  }
</script>
</body>
</html>
