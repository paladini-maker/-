<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromecast Shaka HLS Web Sender</title>
    <!-- Incluir Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales para centrar el contenido */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>

    <!-- INTERFAZ DEL SENDER -->
    <div id="sender-content" class="p-8 max-w-xl w-full bg-white shadow-2xl rounded-xl space-y-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 text-center">Web Sender (M3U8 + Shaka)</h1>
        <p class="text-sm text-gray-500 text-center">Ingresa la URL del stream M3U8 y envíala a tu dispositivo Chromecast.</p>

        <!-- Botón de Cast (Proporcionado por el SDK) -->
        <div class="flex justify-center p-4">
            <google-cast-launcher id="castbutton"></google-cast-launcher>
        </div>

        <div class="space-y-4">
            <label for="m3u8-url" class="block text-sm font-medium text-gray-700">URL del Stream M3U8:</label>
            <input type="url" id="m3u8-url" value="https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8"
                   placeholder="Ej: https://example.com/playlist.m3u8"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
        </div>

        <button id="send-button" disabled
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 transition duration-150 ease-in-out">
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Enviar a Chromecast
        </button>

        <div id="status-message" class="text-center text-sm mt-4 p-2 rounded-md transition duration-300">
            Desconectado. Haz clic en el ícono de Cast.
        </div>
    </div>

    <!-- 1. JQUERY (Google Hosted Libraries: 3.7.1) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- 2. CARGADOR DEL SDK DE SENDER V3 (Fuente oficial de Google Cast - Gstatic) -->
    <script src="//www.gstatic.com/cv/js/sender/api_js/sdk/loader.js"></script>

    <script>
        // Note: We use Vanilla JavaScript for the actual Cast logic as it's the recommended practice.
        
        const RECEIVER_APP_ID = 'AAA48312'; // Custom Receiver App ID
        let castContext;

        function setupSender() {
            console.log('Inicializando la aplicación Web Sender...');
            
            const sendButton = document.getElementById('send-button');
            const urlInput = document.getElementById('m3u8-url');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('spinner');

            // 1. Inicializar el Contexto de Cast v3
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            castContext = cast.framework.CastContext.getInstance();
            
            // 2. Escuchar los cambios de estado de sesión
            castContext.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                (event) => {
                    const sessionState = event.sessionState;
                    const session = castContext.getCurrentSession();
                    
                    if (session && (sessionState === cast.framework.SessionState.SESSION_RESUMED || sessionState === cast.framework.SessionState.SESSION_STARTED)) {
                        // Conectado
                        statusMessage.innerHTML = `<span class="text-green-700 bg-green-100 p-1 rounded">Conectado a: ${session.getReceiver().friendlyName}</span>`;
                        sendButton.disabled = false;
                    } else if (sessionState === cast.framework.SessionState.SESSION_ENDED || sessionState === cast.framework.SessionState.NO_SESSION) {
                        // Desconectado
                        statusMessage.innerHTML = `<span class="text-red-700 bg-red-100 p-1 rounded">Desconectado. Haz clic en el ícono de Cast.</span>`;
                        sendButton.disabled = true;
                    }
                }
            );

            // 3. Manejar el clic en el botón de Enviar
            sendButton.addEventListener('click', async () => {
                const mediaUrl = urlInput.value.trim();
                const currentSession = castContext.getCurrentSession();
                
                if (!mediaUrl || !currentSession) {
                    statusMessage.innerHTML = `<span class="text-red-700 bg-red-100 p-1 rounded">Error: URL no válida o no hay sesión activa.</span>`;
                    return;
                }

                spinner.classList.remove('hidden');
                sendButton.disabled = true;

                try {
                    // Crear MediaInfo, usando el MIME type 'application/x-mpegURL' para HLS
                    const mediaInfo = new chrome.cast.media.MediaInfo(mediaUrl, 'application/x-mpegURL'); 
                    mediaInfo.metadata = new chrome.cast.media.MovieMediaMetadata();
                    mediaInfo.metadata.title = 'Stream M3U8 (Shaka 4.16.11)';
                    mediaInfo.metadata.subtitle = 'Enviado desde GHL-Powered Sender';

                    const request = new chrome.cast.media.LoadRequest(mediaInfo);
                    request.autoplay = true;

                    // Enviar la solicitud de carga al Receiver
                    await currentSession.loadMedia(request);
                    
                    statusMessage.innerHTML = `<span class="text-blue-700 bg-blue-100 p-1 rounded">Contenido enviado exitosamente!</span>`;

                } catch (error) {
                    console.error('Error al enviar la solicitud de carga:', error);
                    statusMessage.innerHTML = `<span class="text-red-700 bg-red-100 p-1 rounded">Error de envío: ${error.message}</span>`;
                } finally {
                    spinner.classList.add('hidden');
                    sendButton.disabled = false;
                }
            });
        }

        // Esta función es llamada automáticamente por el Cast SDK Loader
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                setupSender();
            } else {
                console.error('El SDK de Cast no está disponible.');
            }
        };
    </script>
</body>
              </html>
