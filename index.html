<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sender Web Pro â€” ConexiÃ³n Manual</title>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #121212; color: #e0e0e0; }
    h2 { color: #bb86fc; }
    .control-group { background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
    
    /* Layout Flexible */
    .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    
    /* Estilos de Inputs */
    input { flex: 1; padding: 12px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 4px; min-width: 200px; }
    
    /* Botones Generales */
    button { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; background: #03dac6; color: black; font-weight: bold; font-size: 14px; transition: all 0.2s; }
    button:hover { background: #018786; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; }

    /* BotÃ³n Manual de ConexiÃ³n (Estilo destacado) */
    #connectBtn { background: #bb86fc; color: white; }
    #connectBtn:hover { background: #9955e6; }

    /* Estilos EspecÃ­ficos para el BotÃ³n Oficial de Google */
    #google-cast-button {
        display: inline-block;
        width: 40px; 
        height: 40px; 
        cursor: pointer;
        --connected-color: #03dac6; 
        --disconnected-color: #777;
    }

    label { font-size: 0.9em; color: #aaa; min-width: 70px; }
    #castStatus { font-weight: bold; margin-left: 10px; }
    .status-connected { color: #03dac6; }
    .status-disconnected { color: #cf6679; }
  </style>
</head>
<body>

  <h2>Sender Web Pro</h2>

  <div class="control-group">
    <div class="row">
        <button id="connectBtn">ðŸ“¡ Conectar Manualmente</button>

        <button is="google-cast-button" id="google-cast-button"></button>

        <span id="castStatus" class="status-disconnected">Desconectado</span>
    </div>
  </div>

  <div class="control-group">
    <div class="row">
      <label>MPD:</label>
      <input id="mpdInput" type="text" value="https://cdn.cvattv.com.ar/live/c6eds/Canal7/SA_Live_dash_enc/Canal7.mpd">
    </div>
    <div class="row">
      <label>Key ID:</label>
      <input id="keyIdInput" type="text" value="0123456789abcdef0123456789abcdef" placeholder="Key ID (Hex)">
    </div>
    <div class="row">
      <label>Key:</label>
      <input id="keyInput" type="text" value="0123456789abcdef0123456789abcdef" placeholder="Key Value (Hex)">
    </div>
    <div class="row">
      <button id="loadBtn" disabled>ðŸ“º Enviar al TV</button>
    </div>
  </div>

  <div class="control-group">
    <div class="row">
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
      <button id="stopBtn">Stop</button>
    </div>
    <div class="row">
      <input id="seekInput" type="number" placeholder="Segundos" style="max-width: 100px;">
      <button id="seekBtn">Ir a</button>
      
      <input id="volumeInput" type="range" min="0" max="1" step="0.05" value="1">
      <button id="volBtn">Volumen</button>
    </div>
  </div>

  <script>
    // âš ï¸ REEMPLAZAR CON TU APP ID DE LA CONSOLA DE GOOGLE
    const APPLICATION_ID = 'AAA48312'; 

    let remotePlayer, remoteController;

    // Callback global requerido por la librerÃ­a de Cast
    window['__onGCastApiAvailable'] = function(isAvailable) {
      if (!isAvailable) {
        console.warn('Google Cast API no estÃ¡ disponible (Â¿EstÃ¡s en Chrome?)');
        return;
      }

      // 1. Inicializar el Contexto
      const context = cast.framework.CastContext.getInstance();
      
      context.setOptions({
        receiverApplicationId: APPLICATION_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
      });

      // 2. Inicializar Controladores Remotos (para sincronizar UI automÃ¡ticamente)
      remotePlayer = new cast.framework.RemotePlayer();
      remoteController = new cast.framework.RemotePlayerController(remotePlayer);

      // 3. Listener de Eventos de ConexiÃ³n
      remoteController.addEventListener(cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED, function() {
        updateUI(remotePlayer.isConnected);
      });
      
      // Comprobar estado inicial por si ya estaba conectado (page refresh)
      updateUI(remotePlayer.isConnected);
    };

    // FunciÃ³n para manejar la UI segÃºn estado
    function updateUI(isConnected) {
        const statusElem = document.getElementById('castStatus');
        const loadBtn = document.getElementById('loadBtn');
        const connectBtn = document.getElementById('connectBtn');

        if (isConnected) {
            statusElem.textContent = 'Conectado';
            statusElem.className = 'status-connected';
            loadBtn.disabled = false;
            connectBtn.textContent = 'Desconectar';
        } else {
            statusElem.textContent = 'Desconectado';
            statusElem.className = 'status-disconnected';
            loadBtn.disabled = true;
            connectBtn.textContent = 'ðŸ“¡ Conectar Manualmente';
        }
    }

    // --- LÃ“GICA DEL BOTÃ“N MANUAL ---
    document.getElementById('connectBtn').addEventListener('click', () => {
        const context = cast.framework.CastContext.getInstance();
        
        if (context.getCastState() === cast.framework.CastState.CONNECTED) {
            // Si ya estÃ¡ conectado, desconectamos
            context.endCurrentSession(true);
        } else {
            // Si no, pedimos sesiÃ³n (esto abre el popup nativo de Chrome)
            context.requestSession().then(() => {
                console.log('SesiÃ³n iniciada correctamente');
            }).catch((e) => {
                if (e !== 'cancel') {
                    console.error('Error al solicitar sesiÃ³n:', e);
                }
            });
        }
    });

    // --- LÃ“GICA DE CARGA DE MEDIA (DASH + ClearKey) ---
    async function loadMedia() {
      const session = cast.framework.CastContext.getInstance().getCurrentSession();
      if (!session) return;

      const url = document.getElementById('mpdInput').value;
      const keyId = document.getElementById('keyIdInput').value.trim();
      const key = document.getElementById('keyInput').value.trim();

      const mediaInfo = new chrome.cast.media.MediaInfo(url, 'application/dash+xml');
      
      // Metadata (Opcional, para que se vea bonito en la pantalla de carga)
      mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
      mediaInfo.metadata.title = "Stream Seguro";
      mediaInfo.metadata.subtitle = "DASH + ClearKey";

      // ConstrucciÃ³n del objeto customData para enviar las llaves
      if(keyId && key) {
          mediaInfo.customData = {
            license: {
              keys: { [keyId]: key }
            }
          };
      }

      const request = new chrome.cast.media.LoadRequest(mediaInfo);
      request.autoplay = true;

      try {
        await session.loadMedia(request);
        console.log('Solicitud de carga enviada');
      } catch (e) {
        console.error('Error enviando media:', e);
      }
    }

    // Bindings de botones
    document.getElementById('loadBtn').addEventListener('click', loadMedia);

    // Controles de reproducciÃ³n (Usando el controller para mayor estabilidad)
    document.getElementById('playBtn').addEventListener('click', () => remoteController && remoteController.playOrPause());
    document.getElementById('pauseBtn').addEventListener('click', () => remoteController && remoteController.playOrPause());
    document.getElementById('stopBtn').addEventListener('click', () => remoteController && remoteController.stop());
    
    document.getElementById('seekBtn').addEventListener('click', () => {
        if(remotePlayer) {
            remotePlayer.currentTime = Number(document.getElementById('seekInput').value);
            remoteController.seek();
        }
    });

    document.getElementById('volBtn').addEventListener('click', () => {
        if(remotePlayer) {
            remotePlayer.volumeLevel = Number(document.getElementById('volumeInput').value);
            remoteController.setVolumeLevel();
        }
    });
  </script>
</body>
</html>
