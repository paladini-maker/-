<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromecast Sender Simple</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter para mejor estética -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal de la Aplicación -->
    <div class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">
            <span class="text-indigo-600">Cast</span> Multimedia
        </h1>
        <p class="text-center text-gray-500">
            Envía contenido a tu Chromecast (ID: 7DB61927).
        </p>

        <!-- Área de Estado -->
        <div id="status-display" class="p-3 text-sm font-medium rounded-lg text-center bg-gray-100 text-gray-600">
            Esperando inicialización de Cast...
        </div>

        <!-- Campo de Entrada de URL -->
        <input type="url" id="media-url" placeholder="Pega aquí la URL del video o audio (e.g., .mp4, .mp3)"
            value="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
            required>

        <!-- Botones de Acción -->
        <div class="flex flex-col space-y-3">
            <!-- Botón oficial de Google Cast (lo maneja todo: conexión, desconexión) -->
            <button id="cast-button" is="google-cast-button"
                class="w-full h-12 flex items-center justify-center bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                Conectar a Chromecast
            </button>

            <!-- Botón de Reproducir/Enviar Media -->
            <button id="play-button" disabled
                class="w-full h-12 flex items-center justify-center bg-green-500 text-white font-semibold py-2 px-4 rounded-lg opacity-50 cursor-not-allowed transition duration-150 shadow-md"
                onclick="loadMedia()">
                Reproducir Media
            </button>
        </div>
    </div>

    <!-- Script de la API de Google Cast (Debe cargarse antes que el script principal) -->
    <script src="//www.gstatic.com/cv/js/sender/loader.js?loadCastFramework=1"></script>

    <script>
        // Declaración de variables globales
        const RECEIVER_APPLICATION_ID = '7DB61927';
        let castContext = null;
        let currentSession = null;
        
        // Elementos del DOM
        const statusDisplay = document.getElementById('status-display');
        const mediaUrlInput = document.getElementById('media-url');
        const playButton = document.getElementById('play-button');
        const castButton = document.getElementById('cast-button');


        /**
         * Inicializa el contexto de Cast al cargar la API.
         * Esta función es llamada automáticamente por la API de Cast.
         */
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                // 1. Configuración de la aplicación
                const sessionRequest = new chrome.cast.SessionRequest(RECEIVER_APPLICATION_ID);
                const apiConfig = new chrome.cast.ApiConfig(
                    sessionRequest,
                    sessionListener,
                    receiverListener,
                    chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                    chrome.cast.DefaultActionPolicy.CREATE_SESSION
                );

                // 2. Inicialización del contexto
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions(apiConfig);
                
                // 3. Listener para el estado de la sesión
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    handleSessionStateChange
                );

                statusDisplay.textContent = 'Cast Framework inicializado. ¡Listo para conectar!';
                
            } else {
                statusDisplay.textContent = 'Error: La API de Google Cast no está disponible.';
                statusDisplay.classList.add('bg-red-200', 'text-red-800');
            }
        };

        /**
         * Escucha los cambios de estado de la sesión.
         * @param {cast.framework.SessionStateEvent} event
         */
        function handleSessionStateChange(event) {
            currentSession = castContext.getCurrentSession();
            
            // Actualizar la interfaz de usuario según el estado
            switch (event.sessionState) {
                case cast.framework.SessionState.NO_SESSION:
                    // Sesión terminada o no iniciada
                    statusDisplay.textContent = 'Desconectado. Pulsa Cast para conectar.';
                    statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-gray-100 text-gray-600';
                    playButton.disabled = true;
                    playButton.classList.add('opacity-50', 'cursor-not-allowed');
                    playButton.classList.remove('hover:bg-green-600');
                    break;

                case cast.framework.SessionState.SESSION_STARTED:
                    // Sesión iniciada y conectada
                    statusDisplay.textContent = 'Conectado a ' + currentSession.getCastDevice().friendlyName + '. Carga la media.';
                    statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-green-100 text-green-800';
                    playButton.disabled = false;
                    playButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    playButton.classList.add('hover:bg-green-600');
                    break;

                case cast.framework.SessionState.SESSION_ENDING:
                    // Opcional: Manejar el final de la sesión
                    statusDisplay.textContent = 'Terminando sesión...';
                    statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-yellow-100 text-yellow-800';
                    break;
                    
                case cast.framework.SessionState.SESSION_RESUMED:
                    // Sesión reanudada
                    statusDisplay.textContent = 'Sesión reanudada en ' + currentSession.getCastDevice().friendlyName + '. Carga la media.';
                    statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-green-100 text-green-800';
                    playButton.disabled = false;
                    playButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    playButton.classList.add('hover:bg-green-600');
                    break;
            }
        }

        /**
         * Listener para nuevas sesiones.
         * @param {chrome.cast.Session} session
         */
        function sessionListener(session) {
            // Este listener es necesario para la configuración, pero el manejo principal 
            // de la UI lo hacemos en handleSessionStateChange.
            // Si quieres guardar la sesión directamente aquí, puedes hacerlo:
            // currentSession = session; 
        }

        /**
         * Listener para la disponibilidad del receptor (opcional).
         * @param {chrome.cast.ReceiverAvailability} availability
         */
        function receiverListener(availability) {
            if (availability === chrome.cast.ReceiverAvailability.AVAILABLE) {
                // Hay dispositivos Cast disponibles en la red
                castButton.textContent = 'Conectar a Chromecast';
            } else {
                // No hay dispositivos Cast disponibles
                castButton.textContent = 'No hay dispositivos Cast';
            }
        }
        
        /**
         * Carga el contenido multimedia en el receptor.
         */
        function loadMedia() {
            if (!currentSession) {
                statusDisplay.textContent = 'Error: No hay sesión activa. Conéctate primero.';
                statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-red-200 text-red-800';
                return;
            }

            const mediaUrl = mediaUrlInput.value.trim();
            if (!mediaUrl) {
                statusDisplay.textContent = 'Por favor, introduce una URL válida.';
                statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-yellow-100 text-yellow-800';
                return;
            }
            
            // Determinar el tipo de contenido (simplemente usando una heurística básica)
            let contentType = 'video/mp4'; // Valor por defecto
            if (mediaUrl.toLowerCase().endsWith('.mp3')) {
                contentType = 'audio/mp3';
            } else if (mediaUrl.toLowerCase().endsWith('.m3u8')) {
                contentType = 'application/x-mpegurl'; // HLS
            }

            // 1. Crear el objeto MediaInfo
            const mediaInfo = new chrome.cast.media.MediaInfo(mediaUrl, contentType);

            // 2. Crear el objeto LoadRequest
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            
            // 3. Obtener el cliente de media y enviar la solicitud
            const media = currentSession.getMediaSession();

            if (media) {
                // Si ya hay una sesión de media, recargar
                media.load(request, 
                    () => { statusDisplay.textContent = 'Media cargada exitosamente: ' + mediaUrl; statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-blue-100 text-blue-800'; }, 
                    (error) => { console.error('Error al cargar media:', error); statusDisplay.textContent = 'Error al cargar media: ' + error.code; statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-red-200 text-red-800'; }
                );
            } else {
                 // Si no hay sesión de media, solicitar una nueva carga
                 currentSession.loadMedia(request, 
                    () => { statusDisplay.textContent = 'Media cargada exitosamente: ' + mediaUrl; statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-blue-100 text-blue-800'; }, 
                    (error) => { console.error('Error al cargar media:', error); statusDisplay.textContent = 'Error al cargar media: ' + error.code; statusDisplay.className = 'p-3 text-sm font-medium rounded-lg text-center bg-red-200 text-red-800'; }
                );
            }
        }
    </script>
</body>
</html>