<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test IPTV + Shaka + Cast (Simple)</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/controls.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/shaka-player.compiled.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/shaka-player.ui.min.js"></script>

  <!-- Chromecast sender -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <style>
    body { background:#000; color:#fff; margin:0; padding:10px; font-family:Arial; }
    #video-container { width:100%; height:55vh; background:#111; }
    #log { background:#111; color:#0f0; padding:10px; margin-top:10px; height:30vh; overflow-y:auto; font-size:12px; }
    button, select { padding:6px; margin:5px; }
  </style>
</head>

<body>

<h3>TEST IPTV + SHAKA + CAST</h3>

<div>
  <button onclick="loadM3U()">Cargar M3U</button>
  <select id="canales"></select>
  <button onclick="playSelected()">Reproducir</button>
</div>

<div id="video-container">
  <video id="video" style="width:100%; height:100%;" autoplay></video>
</div>

<div id="log"></div>

<script>
const M3U_FILE = "https://raw.githubusercontent.com/paladini-maker/-/refs/heads/main/002.m3u";
let channels = [];
let player;

function log(x){
  console.log(x);
  const div = document.getElementById("log");
  div.innerText += x + "\n";
  div.scrollTop = div.scrollHeight;
}

document.addEventListener("DOMContentLoaded", async () => {
  shaka.polyfill.installAll();

  // Player base
  player = new shaka.Player(document.getElementById("video"));

  // UI mínima, sin stats, sin overlays de WebGL
  const ui = new shaka.ui.Overlay(
    player,
    document.getElementById("video-container"),
    document.getElementById("video")
  );

  ui.configure({
    addSeekBar: true,
    controlPanelElements: ['play_pause', 'mute', 'volume', 'fullscreen', 'overflow_menu'],
    overflowMenuButtons: ['cast', 'quality'],
    statistics: { showPanel: false },
    castReceiverAppId: 'CC1AD845'
  });

  player.addEventListener('error', e => log("ERROR: " + e.detail.code));
  log("Shaka inicializado.");
});

// ------------------------
// CARGA DEL M3U
// ------------------------
async function loadM3U(){
  log("Cargando M3U...");
  try {
    const r = await fetch(M3U_FILE);
    const txt = await r.text();
    parseM3U(txt);
  } catch(e){
    log("Error M3U: " + e.message);
  }
}

function parseM3U(text){
  const lines = text.split(/\n/);
  let tmp = null;
  channels = [];

  for(const raw of lines){
    const line = raw.trim();
    if(line.startsWith("#EXTINF:")){
      let name = line.split(",").pop().trim();
      tmp = { name, url:"", license:null };
    }
    else if(line.includes("license_key=") && tmp){
      const lk = line.split("license_key=")[1].trim();
      const parts = lk.split(":");
      if(parts.length >= 2) tmp.license = { [parts[0]]: parts[1] };
    }
    else if(!line.startsWith("#") && tmp){
      tmp.url = line.trim();
      channels.push(tmp);
      tmp=null;
    }
  }

  const sel = document.getElementById("canales");
  sel.innerHTML = "";
  channels.forEach((c,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = c.name + (c.license ? " [DRM]" : "");
    sel.appendChild(opt);
  });

  log("Canales cargados: " + channels.length);
}

// ------------------------
// REPRODUCIR
// ------------------------
async function playSelected(){
  const idx = document.getElementById("canales").value;
  const ch = channels[idx];
  if(!ch) return;

  log("Reproduciendo: " + ch.name);

  const drmConfig = ch.license ? { clearKeys: ch.license } : {};

  player.configure({ drm: drmConfig });

  try {
    await player.unload();
    await player.load(ch.url);
    log("Reproducción OK.");
  } catch(err){
    log("Error: " + err.code);
  }
}

</script>

</body>
</html>
