<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromecast Sender App (ID: 7DB61927)</title>
    <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente principal Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* Estilos para el Web Component (google-cast-launcher) */
        google-cast-launcher {
            --google-cast-icon-color: #4f46e5;
            --google-cast-icon-color-hover: #4338ca;
            cursor: pointer;
            outline: none;
            display: block;
            /* Aseguramos un tamaño mínimo para que el componente interno pueda renderizarse */
            width: 32px;
            height: 32px;
        }

        /* Ocultamos el botón si el SDK no está disponible o no hay dispositivos (manejo por defecto del SDK) */
        #castButton {
            /* Dejamos que el SDK controle si lo muestra o no */
            display: block; 
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6">

        <h1 class="text-3xl font-extrabold text-indigo-700 text-center">
            Sender para Receptor Chromecast
        </h1>
        <p class="text-center text-sm text-gray-500">
            ID de la Aplicación: <code class="font-mono bg-indigo-100 px-2 py-1 rounded text-indigo-700">7DB61927</code>
        </p>

        <!-- AVISO CRÍTICO DE COMPATIBILIDAD CON CHROME EN ANDROID (HTTPS) -->
        <div class="p-3 text-xs rounded-lg bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 font-medium">
            ¡IMPORTANTE! Para asegurar la compatibilidad con Chrome en Android, esta aplicación **DEBE** ser accedida a través de **HTTPS**. Los navegadores móviles bloquean la API de Cast en orígenes inseguros (HTTP).
        </div>

        <!-- Botones de Conexión -->
        <div class="flex flex-col items-center justify-center space-y-3 pt-4 pb-2">
            
            <!-- Opción 1: Web Component oficial (puede fallar en renderizado) -->
            <div class="flex items-center space-x-2 text-gray-600">
                <!-- Mostramos el componente oficial, si se renderiza -->
                <google-cast-launcher id="castButton"></google-cast-launcher>
                <span class="text-sm">Intenta presionar el icono si aparece.</span>
            </div>

            <!-- Opción 2: Botón de Reserva (Fallback Button) - Este es el método robusto -->
            <button onclick="requestCastSession()" id="manualCastButton" 
                    class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50"
            >
                <!-- Icono de Cast SVG manual -->
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 11c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-6 8h12c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2zm12-9.5c0 .28-.22.5-.5.5h-1c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h1c.28 0 .5.22.5.5zM6 16h12v-2H6v2z"/></svg>
                <span>Conectar con Chromecast (Reserva)</span>
            </button>
        </div>


        <!-- Estado de la Sesión -->
        <div id="statusMessage" class="text-center p-3 rounded-lg text-sm transition-all duration-300 bg-blue-100 text-blue-700 font-medium">
            Esperando inicialización del SDK...
        </div>

        <!-- Controles de Medios (Ocultos hasta la conexión) -->
        <div id="mediaControls" class="space-y-4 border-t pt-6 mt-6 border-gray-200 hidden">
            
            <h2 class="text-xl font-semibold text-gray-800">Cargar Contenido</h2>

            <input type="text" id="mediaUrlInput" 
                   value="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" 
                   placeholder="URL del Medio (MP4, etc.)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
            >
            
            <button onclick="loadMedia()" id="loadButton" 
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50"
            >
                Cargar y Reproducir
            </button>

            <!-- Controles de Reproducción -->
            <div class="flex justify-between space-x-3 pt-4">
                <button onclick="playMedia()" id="playButton" disabled
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition disabled:opacity-50"
                >
                    <!-- Icono de Play -->
                    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button onclick="pauseMedia()" id="pauseButton" disabled
                        class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 rounded-lg transition disabled:opacity-50"
                >
                    <!-- Icono de Pausa -->
                    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button onclick="stopMedia()" id="stopButton" disabled
                        class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg transition disabled:opacity-50"
                >
                    <!-- Icono de Detener -->
                    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10H8m2 0h1m-2 2h1m-2 2h1m-1-4h.01M17 10h.01M17 14h.01M12 12h.01M16 12h.01M17 16h.01M16 16h.01M16 8h.01M12 8h.01"></path></svg>
                </button>
            </div>
            
            <p id="currentMediaStatus" class="text-sm text-gray-600 text-center pt-2">
                Sin medio cargado.
            </p>
        </div>

    </div>

    <!-- Carga del SDK de Cast -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

    <script>
        // --- Variables Globales ---
        let castSession = null;
        let isCastInitialized = false;

        // --- Elementos del DOM ---
        const statusMessage = document.getElementById('statusMessage');
        const mediaControls = document.getElementById('mediaControls');
        const mediaUrlInput = document.getElementById('mediaUrlInput');
        const playButton = document.getElementById('playButton');
        const pauseButton = document.getElementById('pauseButton');
        const stopButton = document.getElementById('stopButton');
        const manualCastButton = document.getElementById('manualCastButton');

        /**
         * Actualiza el mensaje de estado en la UI.
         */
        function updateStatus(message, type = 'info') {
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-700';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-700';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-700';
                    break;
            }
            statusMessage.className = `text-center p-3 rounded-lg text-sm transition-all duration-300 font-medium ${bgColor} ${textColor}`;
            statusMessage.innerText = message;
            console.log(`[STATUS] ${message}`);
        }

        /**
         * Habilita o deshabilita los botones de control de medios.
         */
        function toggleMediaControls(isEnabled) {
            if (isEnabled) {
                mediaControls.classList.remove('hidden');
                playButton.disabled = false;
                pauseButton.disabled = false;
                stopButton.disabled = false;
                manualCastButton.disabled = true; // Deshabilita el botón manual cuando ya estás conectado
            } else {
                mediaControls.classList.add('hidden');
                playButton.disabled = true;
                pauseButton.disabled = true;
                stopButton.disabled = true;
                manualCastButton.disabled = !isCastInitialized; // Habilita si el SDK está inicializado
                document.getElementById('currentMediaStatus').innerText = 'Sin medio cargado.';
            }
        }

        /**
         * Inicializa el Framework de Cast.
         */
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                isCastInitialized = true;
                initializeCastApi();
                
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    updateStatus('Advertencia: El Cast Button podría no funcionar en Chrome móvil (Android) porque la página NO se sirve vía HTTPS. Por favor, usa el botón de Reserva.', 'error');
                } else {
                    updateStatus('SDK de Cast disponible. Puedes usar el botón de Reserva para conectar.', 'info');
                }
                toggleMediaControls(false); // Asegura que el botón manual esté habilitado
            } else {
                updateStatus('Error: SDK de Cast no disponible.', 'error');
                isCastInitialized = false;
                toggleMediaControls(false);
            }
        };

        function initializeCastApi() {
            const context = cast.framework.CastContext.getInstance();
            
            context.setOptions({
                receiverApplicationId: '7DB61927',
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            // Escuchar cambios en la sesión de Cast
            context.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                onSessionStateChanged);
        }

        /**
         * Inicia una sesión de Cast manualmente, forzando la apertura del selector.
         * Esta es la función de "Botón de Reserva".
         */
        function requestCastSession() {
            if (!isCastInitialized) {
                updateStatus('El SDK de Cast aún no está listo. Inténtalo de nuevo en breve.', 'error');
                return;
            }
            
            updateStatus('Intentando iniciar sesión de Cast manualmente...', 'info');
            
            cast.framework.CastContext.getInstance().requestSession()
                .then(
                    () => console.log('requestSession exitoso'),
                    (error) => {
                        // Manejo de errores de inicio de sesión (e.g., el usuario cancela, no hay dispositivos)
                        if (error.code !== 'cancel') {
                            updateStatus(`Error al conectar: ${error.code} - ${error.description || 'Consulta la consola para más detalles.'}`, 'error');
                            console.error('Error requestSession:', error);
                        } else {
                            updateStatus('Conexión cancelada por el usuario.', 'info');
                        }
                    }
                );
        }

        /**
         * Maneja los cambios de estado de la sesión (Conectado, Desconectado, etc.)
         */
        function onSessionStateChanged(event) {
            castSession = cast.framework.CastContext.getInstance().getCurrentSession();

            switch (event.sessionState) {
                case cast.framework.SessionState.SESSION_STARTED:
                case cast.framework.SessionState.SESSION_RESUMED:
                    updateStatus('Conectado al dispositivo.', 'success');
                    toggleMediaControls(true);
                    if (castSession.getMediaSession()) {
                        castSession.getMediaSession().addEventListener(
                            chrome.cast.media.MediaSessionEventType.STATUS_CHANGED,
                            onMediaStatusChanged
                        );
                    }
                    break;

                case cast.framework.SessionState.SESSION_ENDED:
                    updateStatus('Desconectado. Usa el botón de Reserva para reconectar.', 'info');
                    toggleMediaControls(false);
                    castSession = null;
                    break;

                case cast.framework.SessionState.NO_SESSION:
                    updateStatus('Listo para conectar. Usa el botón de Reserva.', 'info');
                    toggleMediaControls(false);
                    castSession = null;
                    break;
                
                case cast.framework.SessionState.SESSION_START_FAILED:
                    updateStatus('Falló el inicio de la sesión. Asegúrate de que el receptor está en línea y usando el ID 7DB61927.', 'error');
                    toggleMediaControls(false);
                    castSession = null;
                    break;
            }
        }

        /**
         * Maneja los cambios de estado del medio (Reproduciendo, Pausado, etc.)
         */
        function onMediaStatusChanged(event) {
            const mediaSession = event.target;
            const statusElement = document.getElementById('currentMediaStatus');
            
            if (mediaSession && mediaSession.playerState) {
                statusElement.innerText = `Estado: ${mediaSession.playerState}`;
                console.log(`[MEDIA STATUS] Nuevo estado: ${mediaSession.playerState}`);
            } else {
                 statusElement.innerText = 'Sin medio cargado.';
            }
        }

        /**
         * Carga el medio con la URL especificada en la sesión de Cast actual.
         */
        function loadMedia() {
            if (!castSession) {
                updateStatus('Error: No hay sesión de Cast activa.', 'error');
                return;
            }

            const mediaUrl = mediaUrlInput.value.trim();
            if (!mediaUrl) {
                updateStatus('Por favor, introduce una URL de medio válida.', 'error');
                return;
            }

            updateStatus(`Intentando cargar medio: ${mediaUrl}`, 'info');

            const mediaInfo = new chrome.cast.media.MediaInfo(mediaUrl, 'video/mp4'); 
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = "Contenido de Prueba (Web Sender)";
            mediaInfo.metadata.subtitle = "Cargado desde App: 7DB61927";

            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            request.autoplay = true;

            castSession.loadMedia(request)
                .then(function() {
                    updateStatus('Medio cargado y reproduciendo con éxito.', 'success');
                })
                .catch(function(error) {
                    updateStatus(`Error al cargar el medio: ${error.code} - ${error.description}`, 'error');
                    console.error('Error al cargar medio:', error);
                });
        }

        /**
         * Envía un comando de PLAY al medio actual.
         */
        function playMedia() {
            const mediaSession = castSession?.getMediaSession();
            if (mediaSession) {
                const request = new chrome.cast.media.PlayRequest();
                mediaSession.play(request)
                    .then(() => console.log('Comando PLAY enviado.'),
                          (error) => console.error('Error al enviar PLAY:', error));
            } else {
                updateStatus('No hay medio cargado o sesión de Cast activa.', 'error');
            }
        }

        /**
         * Envía un comando de PAUSE al medio actual.
         */
        function pauseMedia() {
            const mediaSession = castSession?.getMediaSession();
            if (mediaSession) {
                const request = new chrome.cast.media.PauseRequest();
                mediaSession.pause(request)
                    .then(() => console.log('Comando PAUSE enviado.'),
                          (error) => console.error('Error al enviar PAUSE:', error));
            } else {
                updateStatus('No hay medio cargado o sesión de Cast activa.', 'error');
            }
        }
        
        /**
         * Envía un comando de STOP al medio actual.
         */
        function stopMedia() {
            const mediaSession = castSession?.getMediaSession();
            if (mediaSession) {
                const request = new chrome.cast.media.StopRequest();
                mediaSession.stop(request)
                    .then(() => updateStatus('Reproducción detenida.', 'info'),
                          (error) => console.error('Error al enviar STOP:', error));
            } else {
                updateStatus('No hay medio cargado o sesión de Cast activa.', 'error');
            }
        }
    </script>
</body>
</html>