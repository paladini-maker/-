<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Sender para Google Cast (Beta)</title>
  <script src="https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js"></script>
  <style>
    :root{--bg:#f4f4f9;--card:#fff;--muted:#6b7280;--accent:#007bff}
    html,body{height:100%;margin:0}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:100%;max-width:720px;padding:18px;border-radius:10px;background:var(--card);box-shadow:0 6px 18px rgba(16,24,40,0.06);text-align:center}
    h1{margin:0 0 12px;font-size:1.25rem;color:#111827}
    #controls{margin-top:14px;display:flex;flex-direction:column;gap:12px;align-items:center}
    google-cast-button{--google-cast-button-width:36px;--google-cast-button-height:36px}
    button{appearance:none;border:0;border-radius:8px;padding:10px 16px;font-size:1rem;background:var(--accent);color:#fff;cursor:pointer}
    button:disabled{background:#cfcfcf;cursor:not-allowed}
    #status{margin-top:8px;padding:10px;border-radius:8px;background:#f0f2f5;color:var(--muted);font-weight:600}
    .meta{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="card">
    <h1>Web Sender: Envío de Video de Muestra</h1>
    <div id="controls">
      <div style="display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap">
        <google-cast-button aria-label="Cast"></google-cast-button>
        <button id="castButton" disabled>Cargar y reproducir</button>
      </div>
      <div id="status" class="meta">Inicializando...</div>
      <div class="meta">Seleccioná un dispositivo con el botón de Cast y luego presioná "Cargar y reproducir".</div>
    </div>
  </div>

  <script>
    (function () {
      const APPLICATION_ID = 'CC1AD845';
      const MEDIA_URL = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
      const MEDIA_TITLE = 'Big Buck Bunny (Muestra)';
      const MEDIA_SUBTITLE = 'Video de prueba para Cast';

      let castContext = null;
      let initialized = false;
      let clickBound = false;

      const castButton = document.getElementById('castButton');
      const statusEl = document.getElementById('status');

      function setStatus(text, color) {
        if (!statusEl) return;
        statusEl.textContent = text;
        statusEl.style.color = color || '';
      }

      function log() {
        if (window.console && console.log) console.log.apply(console, ['[Cast Sender]'].concat(Array.from(arguments)));
      }

      window.__onGCastApiAvailable = function (isAvailable) {
        if (isAvailable) {
          setStatus('API Cast disponible.', 'green');
          initCast();
        } else {
          setStatus('API Cast no disponible.', 'crimson');
          setTimeout(initCast, 1000);
        }
      };

      function initCast() {
        if (initialized) return;
        try {
          if (!window.cast || !window.cast.framework) throw new Error('Cast SDK no cargado');

          castContext = window.cast.framework.CastContext.getInstance();
          castContext.setOptions({ receiverApplicationId: APPLICATION_ID });
          castContext.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, onSessionChange);

          if (castButton) {
            castButton.disabled = false;
            if (!clickBound) {
              castButton.addEventListener('click', onCastClick);
              clickBound = true;
            }
          }

          initialized = true;
          setStatus('Listo. Seleccioná dispositivo y presioná Cargar.');
          log('Cast inicializado');
        } catch (err) {
          setStatus('Error al inicializar Cast.', 'crimson');
          if (castButton) castButton.disabled = true;
          log('init error', err && err.message ? err.message : err);
        }
      }

      function onSessionChange(event) {
        const state = event && event.sessionState;
        if (state === cast.framework.SessionState.SESSION_STARTED) setStatus('Sesión iniciada.', 'purple');
        else if (state === cast.framework.SessionState.SESSION_RESUMED) setStatus('Sesión reanudada.', 'purple');
        else if (state === cast.framework.SessionState.SESSION_ENDED) setStatus('Sesión terminada.', 'grey');
      }

      async function onCastClick() {
        if (!castContext) return setStatus('Cast no inicializado.', 'crimson');

        try {
          const session = typeof castContext.getCurrentSession === 'function' ? castContext.getCurrentSession() : null;
          if (session && typeof session.isConnected === 'function' && session.isConnected()) {
            await sendToSession(session);
            return;
          }

          setStatus('Solicitando sesión...', 'orange');
          const newSession = await castContext.requestSession();
          if (newSession && typeof newSession.isConnected === 'function' && newSession.isConnected()) {
            await sendToSession(newSession);
          } else {
            setStatus('No se pudo iniciar la sesión.', 'crimson');
          }
        } catch (e) {
          setStatus('Error solicitando sesión.', 'crimson');
          log('requestSession error', e && e.message ? e.message : e);
        }
      }

      function buildRequest() {
        if (!window.chrome || !chrome.cast || !chrome.cast.media) throw new Error('API media no disponible');
        const metadata = new chrome.cast.media.MediaMetadata(chrome.cast.media.MetadataType.MOVIE);
        metadata.title = MEDIA_TITLE;
        metadata.subtitle = MEDIA_SUBTITLE;

        const info = new chrome.cast.media.MediaInfo(MEDIA_URL, 'video/mp4');
        info.streamType = chrome.cast.media.StreamType.BUFFERED;
        info.metadata = metadata;

        const req = new chrome.cast.media.LoadRequest(info);
        req.autoplay = true;
        req.playPosition = 0;
        return req;
      }

      async function sendToSession(session) {
        if (!session || typeof session.isConnected !== 'function' || !session.isConnected()) {
          setStatus('No hay sesión activa.', 'crimson');
          return;
        }

        setStatus('Enviando media...', 'blue');

        let req;
        try {
          req = buildRequest();
        } catch (err) {
          setStatus('Error preparando media.', 'crimson');
          log('buildRequest error', err && err.message ? err.message : err);
          return;
        }

        try {
          await session.loadMedia(req);
          setStatus('Reproduciendo en dispositivo.', 'green');
        } catch (err) {
          setStatus('Error cargando media.', 'crimson');
          log('loadMedia error', err && err.message ? err.message : err);
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        if (window.__onGCastApiAvailable === undefined) setTimeout(initCast, 300);
      });

      if (window.cast && window.cast.framework) initCast();
    })();
  </script>
</body>
</html>
