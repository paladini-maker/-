<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Sender CAF IPTV + Shaka</title>

<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.15.12/shaka-player.compiled.js"></script>

<style>
html,body{margin:0;height:100%;font-family:sans-serif;background:#f7f8fb}
.wrap{max-width:760px;margin:36px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.05);text-align:center}
button{background:#2979ff;color:#fff;border:0;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:1rem}
button:disabled{background:#cfcfcf;cursor:not-allowed}
#status{margin-top:14px;padding:10px;border-radius:8px;background:#f1f5f9;color:#374151;font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <h2>Sender CAF IPTV + Shaka</h2>
  <button id="loadBtn" disabled>Cargar y reproducir</button>
  <div id="status">Inicializando...</div>
</div>

<script>
(async function(){
  const APP_ID = 'AAA48312'; // Cambia por tu Custom Receiver
  const MEDIA_URL = 'https://cdn.cvattv.com.ar/live/c6eds/Canal7/SA_Live_dash_enc/Canal7.mpd';
  const CLEAR_KEYS = {
    "cc8c82ac2ec7e9799527c29db7354e81": "cc4aae173dd2ef17ae26be3f7ae87662"
  };

  const statusEl = document.getElementById('status');
  const loadBtn = document.getElementById('loadBtn');

  function setStatus(text,color){ statusEl.textContent=text; statusEl.style.color=color||'' }

  // Inicializar Cast SDK
  async function initCast(){
    if(!window.cast || !cast.framework) return new Promise(resolve=>{
      window.__onGCastApiAvailable = ()=>resolve();
    });

    const context = cast.framework.CastContext.getInstance();
    context.setOptions({ receiverApplicationId: APP_ID });
    context.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, e=>{
      const s = e.sessionState;
      if(s===cast.framework.SessionState.SESSION_STARTED) setStatus('Sesión iniciada','green');
      else if(s===cast.framework.SessionState.SESSION_ENDED) setStatus('Sesión finalizada','grey');
    });
    return context;
  }

  // Preparar request para media
  function buildRequest(){
    const mediaInfo = new chrome.cast.media.MediaInfo(MEDIA_URL,'application/dash+xml');
    mediaInfo.streamType = chrome.cast.media.StreamType.BUFFERED;
    mediaInfo.customData = { shaka: { drm: { clearKeys: CLEAR_KEYS } } };

    const metadata = new chrome.cast.media.MediaMetadata(chrome.cast.media.MetadataType.MOVIE);
    metadata.title = "TV Pública (ClearKey)";
    mediaInfo.metadata = metadata;

    const request = new chrome.cast.media.LoadRequest(mediaInfo);
    request.autoplay = true;
    request.playPosition = 0;
    return request;
  }

  async function loadMedia(context){
    setStatus('Preparando...','orange');
    let session = context.getCurrentSession && context.getCurrentSession();
    if(!session){
      setStatus('Solicitando sesión...','orange');
      try{ session = await context.requestSession(); }catch(e){ session=null; }
    }
    if(!session){ setStatus('No se pudo establecer sesión','crimson'); return; }

    try{
      await session.loadMedia(buildRequest());
      setStatus('Reproduciendo en el dispositivo','green');
    }catch(e){ setStatus('Error cargando media: '+e,'crimson'); }
  }

  loadBtn.disabled = true;
  const context = await initCast();
  loadBtn.disabled = false;
  loadBtn.addEventListener('click', ()=>loadMedia(context));

  setStatus('Listo','green');
})();
</script>
</body>
</html>
