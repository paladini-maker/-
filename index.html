<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Web Sender para Google Cast (Beta)</title>
    
    <script src="https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px; /* Reducido para móvil */
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
            font-size: 1.5em; /* Ajuste para móvil */
        }
        #controls {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: inline-block;
            background-color: #fff;
        }
        google-cast-button {
            --google-cast-button-color: #4285F4;
            --google-cast-button-width: 32px;
            --google-cast-button-height: 32px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 15px;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            background-color: #eee;
        }
    </style>
</head>
<body>
    <h1>Web Sender: Envío de Video de Muestra</h1>

    <google-cast-button></google-cast-button>

    <p id="status" style="color: grey;">Cargando API de Cast...</p>

    <div id="controls">
        <button id="castButton" disabled>
            Cargar y Reproducir Video (Big Buck Bunny)
        </button>
        <p>Haga clic en el botón de Cast (si aparece) y luego en el botón de Cargar.</p>
    </div>

    <script>
        // ID de la aplicación de Receptor de Medios Predeterminada
        const APPLICATION_ID = 'CC1AD845'; 
        
        // Contenido multimedia de muestra
        const MEDIA_URL = 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
        const MEDIA_TITLE = 'Big Buck Bunny (Muestra)';
        const MEDIA_SUBTITLE = 'Video de prueba para Cast';
        
        let castContext;
        const castButton = document.getElementById('castButton');
        const statusElement = document.getElementById('status');

        /**
         * 1. Callback obligatorio y robusto para inicializar el SDK
         */
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                statusElement.style.color = 'green';
                statusElement.innerText = 'API de Google Cast: DISPONIBLE.';
                setTimeout(initializeCastApi, 100); 
            } else {
                statusElement.style.color = 'red';
                statusElement.innerText = 'API de Cast NO DISPONIBLE. Causa probable: No se detecta Chromecast en tu red.';
                castButton.disabled = true;
                // Intentaremos forzar la inicialización si la API existe, por si acaso
                setTimeout(initializeCastApi, 2000); 
            }
        };

        /**
         * 2. Inicializa el contexto de Cast.
         */
        function initializeCastApi() {
            try {
                // 2.1. Configuración de las opciones de Cast
                const castOptions = new cast.framework.CastOptions();
                castOptions.receiverApplicationId = APPLICATION_ID;
                
                // 2.2. Inicializar el contexto de Cast (singleton)
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions(castOptions);

                // 2.3. Configurar listeners
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    onSessionStateChange
                );
                
                // 2.4. Habilitar el botón y actualizar estado
                castButton.disabled = false;
                castButton.onclick = requestSessionAndLoadMedia;

                // Solo actualizamos el estado si no falló en la etapa anterior (isAvailable=false)
                if (statusElement.style.color !== 'red') {
                    statusElement.style.color = 'blue';
                    statusElement.innerText = 'Cast Context CONFIGURADO. Presiona el botón de Cast (si aparece) o el botón de Cargar.';
                }

            } catch (e) {
                statusElement.style.color = 'red';
                statusElement.innerText = 'ERROR FATAL al configurar el Cast Context: La API no se cargó correctamente.';
                castButton.disabled = true;
            }
        }
        
        /**
         * 3. Maneja los cambios de estado de la sesión.
         */
        function onSessionStateChange(event) {
            if (event.sessionState === cast.framework.SessionState.SESSION_STARTED) {
                 statusElement.style.color = 'purple';
                 statusElement.innerText = 'SESIÓN INICIADA. Ahora puedes presionar el botón de Cargar.';
            } else if (event.sessionState === cast.framework.SessionState.SESSION_ENDED) {
                 statusElement.style.color = 'grey';
                 statusElement.innerText = 'SESIÓN TERMINADA. Vuelve a conectar.';
            }
        }

        /**
         * 4. Solicita una sesión de Cast o carga el medio si ya hay una sesión.
         */
        function requestSessionAndLoadMedia() {
            const session = castContext.getCurrentSession();
            
            if (session && session.isConnected()) {
                loadMedia(session);
            } else {
                statusElement.style.color = 'orange';
                statusElement.innerText = 'Solicitando sesión de Cast...';
                castContext.requestSession().then(function(newSession) {
                    loadMedia(newSession);
                }, function(error) {
                    statusElement.style.color = 'red';
                    statusElement.innerText = 'ERROR al solicitar sesión. Código: ' + (error ? error.code : 'Desconocido');
                });
            }
        }

        /**
         * 5. Crea la solicitud de carga y la envía a la sesión de Cast activa.
         */
        function loadMedia(session) {
            if (!session || !session.isConnected()) {
                statusElement.style.color = 'red';
                statusElement.innerText = "ERROR: No hay una sesión de Cast activa para cargar el medio.";
                return;
            }
            
            statusElement.style.color = 'blue';
            statusElement.innerText = 'Creando y enviando solicitud de carga de medio...';

            const mediaMetadata = new chrome.cast.media.MediaMetadata(chrome.cast.media.MetadataType.MOVIE);
            mediaMetadata.title = MEDIA_TITLE;
            mediaMetadata.subtitle = MEDIA_SUBTITLE;

            const mediaInfo = new chrome.cast.media.MediaInfo(MEDIA_URL, 'video/mp4');
            mediaInfo.metadata = mediaMetadata;

            const loadRequest = new chrome.cast.media.LoadRequest(mediaInfo);

            session.loadMedia(loadRequest).then(
                function() { 
                    statusElement.style.color = 'green';
                    statusElement.innerText = '¡Medio cargado y reproduciéndose exitosamente!';
                }, 
                function(error) { 
                    statusElement.style.color = 'red';
                    statusElement.innerText = 'ERROR al cargar el video. Código: ' + (error ? error.code : 'Desconocido');
                }
            );
        }
    </script>
</body>
</html>
