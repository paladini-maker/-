<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test IPTV + Shaka + Cast</title>

  <!-- Shaka Player -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/controls.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/shaka-player.compiled.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/shaka-player.ui.min.js"></script>

  <!-- Cast -->
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <style>
    body { background:#000; color:#fff; font-family:Arial; margin:0; padding:10px; }
    #video-container { width:100%; height:60vh; background:#111; }
    #log { background:#111; color:#0f0; font-size:12px; padding:10px; height:30vh; overflow-y:auto; margin-top:10px; }
    button { margin:5px; padding:8px; }
  </style>
</head>
<body>

<h3>TEST IPTV + SHAKA + CAST</h3>

<div>
  <button onclick="loadM3U()">Cargar M3U</button>
  <select id="canales"></select>
  <button onclick="playSelected()">Reproducir</button>
</div>

<div id="video-container" data-shaka-player-container>
  <video id="video" data-shaka-player autoplay style="width:100%; height:100%;"></video>
</div>

<div id="log"></div>

<script>
const M3U_FILE = "https://raw.githubusercontent.com/paladini-maker/-/refs/heads/main/002.m3u";
let channels = [];
let player;

function l(x){
  console.log(x);
  const log = document.getElementById("log");
  log.innerText += x + "\n";
  log.scrollTop = log.scrollHeight;
}

document.addEventListener("DOMContentLoaded", async () => {
  shaka.polyfill.installAll();

  player = new shaka.Player();
  await player.attach(document.getElementById("video"));

  // UI mínima
  const ui = new shaka.ui.Overlay(player, document.getElementById("video"), document.getElementById("video-container"));
  ui.configure({
    controlPanelElements: ['play_pause', 'mute', 'volume', 'fullscreen', 'overflow_menu'],
    overflowMenuButtons: ['cast', 'quality'],
    castReceiverAppId: 'CC1AD845'
  });

  player.addEventListener('error', e => l("ERROR: " + e.detail.code));
  l("Shaka inicializado");
});

async function loadM3U(){
  l("Cargando M3U...");
  try {
    const r = await fetch(M3U_FILE);
    const t = await r.text();
    parseM3U(t);
  } catch(e){
    l("Error cargando M3U: "+e.message);
  }
}

function parseM3U(txt){
  const lines = txt.split(/\n/);
  let tmp = null;
  channels = [];

  for(const lineRaw of lines){
    const line = lineRaw.trim();

    if(line.startsWith("#EXTINF:")){
      const name = line.split(",").pop().trim();
      tmp = { name, url:"", license:null };
    }
    else if(line.includes("license_key=") && tmp){
      const raw = line.split("license_key=")[1].trim();
      const parts = raw.split(":");
      if(parts.length >= 2) tmp.license = { [parts[0]]: parts[1] };
    }
    else if(!line.startsWith("#") && tmp){
      tmp.url = line;
      channels.push(tmp);
      tmp = null;
    }
  }

  const sel = document.getElementById("canales");
  sel.innerHTML = "";
  channels.forEach((c,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = c.name + (c.license ? " [DRM]" : "");
    sel.appendChild(opt);
  });

  l("Canales cargados: " + channels.length);
}

async function playSelected(){
  const idx = document.getElementById("canales").value;
  const ch = channels[idx];
  if(!ch) return;

  l("Reproduciendo: "+ch.name);

  player.configure({
    drm: {
      clearKeys: ch.license || {}
    }
  });

  try {
    await player.unload();
    await player.load(ch.url);
    l("Reproducción OK");
  } catch(e){
    l("Error al reproducir: "+e.code);
  }
}
</script>

</body>
</html>
