<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test Shaka + Cast + ClearKey</title>
  
  <!-- Shaka Player UI y Core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.3/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.3/controls.min.css">

  <!-- Google Cast Framework -->
  <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <style>
    body { background: #111; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
    #video-container { width: 80%; max-width: 800px; margin-top: 20px; }
    h2 { margin-top: 20px; }
    /* El botón nativo de Google Cast */
    google-cast-launcher { margin: 20px; cursor: pointer; --connected-color: #4285f4; --disconnected-color: #ccc; }
  </style>
</head>
<body>

  <h2>Test Shaka + Chromecast + ClearKey</h2>

  <!-- Botón Cast -->
  <google-cast-launcher id="cast-button"></google-cast-launcher>

  <!-- Contenedor Shaka -->
  <div id="video-container">
    <video id="video" width="100%" poster="//shaka-player-demo.appspot.com/assets/poster.jpg"></video>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', initApp);

  async function initApp() {
    // 1. Instalar Polyfills
    shaka.polyfill.installAll();

    if (!shaka.Player.isBrowserSupported()) {
      console.error("Shaka: Navegador no soportado");
      return;
    }

    const video = document.getElementById('video');
    const container = document.getElementById('video-container');

    // 2. Inicializar el Reproductor Local
    const player = new shaka.Player(video);

    // 3. Configurar DRM (ClearKey)
    // Shaka enviará esta config al Chromecast a través del Proxy
    const clearKeyConfig = {
      drm: {
        clearKeys: {
          // keyId : key
          "cc8c82ac2ec7e9799527c29db7354e81": "cc4aae173dd2ef17ae26be3f7ae87662"
        }
      }
    };
    player.configure(clearKeyConfig);

    // 4. Inicializar la UI (Opcional, pero recomendado para controles)
    const ui = new shaka.ui.Overlay(player, container, video);
    // Desactivamos el botón de cast de la UI de Shaka para usar el google-cast-launcher externo
    // o dejamos que coexistan. Aquí lo dejaremos por defecto.

    // 5. IMPLEMENTAR EL CAST PROXY (El paso que faltaba)
    // Usamos el App ID de Shaka Demo ('07AEE832') porque sabe manejar ClearKey enviado por config.
    // Si usas el Default Receiver, es posible que no descifre el video.
    const receiverAppId = '07AEE832'; 
    const castProxy = new shaka.cast.CastProxy(video, player, receiverAppId);

    // Conectar el proxy a la UI (para que los controles de la UI controlen el Cast)
    const controls = ui.getControls();
    
    // El CastProxy necesita saber cuándo el usuario interactúa.
    // Dado que usamos <google-cast-launcher>, el framework de Cast maneja el click,
    // y Shaka escucha el cambio de contexto automáticamente.

    const manifestUri = "https://cdn.cvattv.com.ar/live/c6eds/Canal7/SA_Live_dash_enc/Canal7.mpd";

    console.log("Iniciando carga...");

    try {
      // Cargar el manifiesto en el reproductor (o en el Cast si ya está conectado)
      await player.load(manifestUri);
      console.log("Listo: Reproduciendo.");
    } catch (e) {
      console.error("Error cargando MPD:", e);
    }
  }
</script>
</body>
</html>
